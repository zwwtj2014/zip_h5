// È¶ñÈ°µÂ∫îÁî®ÈÄªËæë
class App {
    constructor() {
        this.selectedFiles = [];
        this.startTime = Date.now();
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.setupDragAndDrop();
        
        // È°µÈù¢ËÆøÈóÆÊâìÁÇπ
        window.analytics.pageView('index', {
            entry_time: new Date().toISOString()
        });
        
        console.log('üöÄ App initialized');
    }
    
    bindEvents() {
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const nextBtn = document.getElementById('nextBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
        uploadBox.addEventListener('click', () => {
            window.analytics.buttonClick('upload_box_click');
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files, 'file_input');
        });
        
        // ÊåâÈíÆ‰∫ã‰ª∂
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                window.analytics.buttonClick('next_button', {
                    file_count: this.selectedFiles.length,
                    total_size: this.getTotalSize()
                });
                this.goToFileManager();
            });
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                window.analytics.buttonClick('clear_button', {
                    file_count: this.selectedFiles.length
                });
                this.clearFiles();
            });
        }
    }
    
    setupDragAndDrop() {
        const uploadBox = document.getElementById('uploadBox');
        
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });
        
        uploadBox.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
        });
        
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                window.analytics.fileDragDrop(files.length, this.calculateTotalSize(files));
                this.handleFileSelect(files, 'drag_drop');
            }
        });
    }
    
    handleFileSelect(files, source = 'unknown') {
        if (files.length === 0) return;
        
        // ÈáçÊñ∞ÈÄâÊã©Êñá‰ª∂ÔºàÊåâÁî®Êà∑Ë¶ÅÊ±ÇÔºåÊØèÊ¨°ÈáçÊñ∞ÈÄâÊã©Ôºâ
        this.selectedFiles = Array.from(files);
        
        // Ëé∑ÂèñÊñá‰ª∂Á±ªÂûãÁªüËÆ°
        const fileTypes = this.getFileTypes(this.selectedFiles);
        const totalSize = this.getTotalSize();
        
        // Êñá‰ª∂ÈÄâÊã©ÊâìÁÇπ
        window.analytics.fileSelect(files.length, totalSize, fileTypes);
        
        // ÊòæÁ§∫ÈÄâÊã©ÁöÑÊñá‰ª∂
        this.displaySelectedFiles();
        
        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
        this.showToast(`‚úÖ Â∑≤ÈÄâÊã© ${files.length} ‰∏™Êñá‰ª∂ÔºåÊÄªÂ§ßÂ∞è ${this.formatFileSize(totalSize)}`);
        
        // ÊªöÂä®Âà∞Êñá‰ª∂ÂàóË°®
        setTimeout(() => {
            document.getElementById('selectedFiles')?.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 300);
    }
    
    displaySelectedFiles() {
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        
        selectedFilesDiv.style.display = 'block';
        fileList.innerHTML = '';
        
        // Êõ¥Êñ∞Êñá‰ª∂ËÆ°Êï∞
        if (fileCount) {
            fileCount.textContent = `${this.selectedFiles.length} ‰∏™Êñá‰ª∂`;
        }
        
        this.selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.style.animationDelay = `${index * 0.1}s`;
            
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">${this.getFileIcon(file.name)}</div>
                    <div class="file-details">
                        <h4 title="${file.name}">${this.truncateFileName(file.name, 30)}</h4>
                        <p class="file-size">${this.formatFileSize(file.size)}</p>
                        <p class="file-type">${file.type || 'Êú™Áü•Á±ªÂûã'}</p>
                    </div>
                </div>
                <div class="file-actions">
                    <button class="btn btn-danger btn-small" onclick="app.removeFile(${index})" title="Âà†Èô§Êñá‰ª∂">
                        üóëÔ∏è Âà†Èô§
                    </button>
                </div>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    removeFile(index) {
        const file = this.selectedFiles[index];
        
        // Êñá‰ª∂Âà†Èô§ÊâìÁÇπ
        window.analytics.fileAction('remove', file.name, file.size);
        
        this.selectedFiles.splice(index, 1);
        
        if (this.selectedFiles.length === 0) {
            document.getElementById('selectedFiles').style.display = 'none';
        } else {
            this.displaySelectedFiles();
        }
        
        this.showToast(`üóëÔ∏è Â∑≤Âà†Èô§Êñá‰ª∂ ${this.truncateFileName(file.name, 20)}`);
    }
    
    clearFiles() {
        const fileCount = this.selectedFiles.length;
        this.selectedFiles = [];
        document.getElementById('selectedFiles').style.display = 'none';
        
        this.showToast(`üßπ Â∑≤Ê∏ÖÁ©∫ ${fileCount} ‰∏™Êñá‰ª∂`);
    }
    
    goToFileManager() {
        if (this.selectedFiles.length === 0) {
            this.showToast('‚ö†Ô∏è ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
            return;
        }
        
        // ÁÆÄÂåñÁöÑÊñá‰ª∂‰º†ÈÄíÊñπÊ°àÔºö‰ΩøÁî® sessionStorage Â≠òÂÇ®Âü∫Êú¨‰ø°ÊÅØÔºåÊñá‰ª∂ÂØπË±°Â≠òÂÇ®Âú®ÂÖ®Â±ÄÂèòÈáè
        const fileData = this.selectedFiles.map(file => ({
            name: file.name,
            size: file.size,
            type: file.type || '',
            lastModified: file.lastModified
        }));
        
        try {
            sessionStorage.setItem('selectedFilesData', JSON.stringify(fileData));
            // Êñá‰ª∂ÂØπË±°Â≠òÂÇ®Âú®ÂÖ®Â±ÄÂèòÈáè‰∏≠ÔºàÊåâÁî®Êà∑Ë¶ÅÊ±ÇÁöÑÁÆÄÂåñÊñπÊ°àÔºâ
            window.selectedFilesForTransfer = this.selectedFiles;
            
            // È°µÈù¢Ë∑≥ËΩ¨ÊâìÁÇπ
            window.analytics.track('page_navigate', {
                from: 'index',
                to: 'file_manager',
                file_count: this.selectedFiles.length,
                total_size: this.getTotalSize()
            });
            
            window.location.href = 'file-manager.html';
        } catch (error) {
            window.analytics.error('file_transfer_error', error.message);
            this.showToast('‚ùå Êñá‰ª∂‰º†ÈÄíÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
        }
    }
    
    // Â∑•ÂÖ∑ÊñπÊ≥ï
    getFileTypes(files) {
        const types = {};
        files.forEach(file => {
            const ext = this.getFileExtension(file.name);
            types[ext] = (types[ext] || 0) + 1;
        });
        return types;
    }
    
    getFileExtension(fileName) {
        return fileName.split('.').pop().toLowerCase() || 'unknown';
    }
    
    getTotalSize() {
        return this.selectedFiles.reduce((sum, file) => sum + file.size, 0);
    }
    
    calculateTotalSize(files) {
        return Array.from(files).reduce((sum, file) => sum + file.size, 0);
    }
    
    truncateFileName(fileName, maxLength) {
        if (fileName.length <= maxLength) return fileName;
        
        const ext = fileName.split('.').pop();
        const name = fileName.substring(0, fileName.lastIndexOf('.'));
        const truncatedName = name.substring(0, maxLength - ext.length - 4) + '...';
        
        return `${truncatedName}.${ext}`;
    }
    
    getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const iconMap = {
            // ÊñáÊ°£Á±ª
            'pdf': 'üìÑ',
            'doc': 'üìù', 'docx': 'üìù',
            'xls': 'üìä', 'xlsx': 'üìä', 'csv': 'üìä',
            'ppt': 'üìà', 'pptx': 'üìà',
            'txt': 'üìÉ', 'rtf': 'üìÉ',
            
            // ÂõæÁâáÁ±ª
            'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
            'bmp': 'üñºÔ∏è', 'svg': 'üñºÔ∏è', 'webp': 'üñºÔ∏è', 'ico': 'üñºÔ∏è',
            
            // ËßÜÈ¢ëÁ±ª
            'mp4': 'üé•', 'avi': 'üé•', 'mov': 'üé•', 'wmv': 'üé•',
            'flv': 'üé•', 'mkv': 'üé•', 'webm': 'üé•',
            
            // Èü≥È¢ëÁ±ª
            'mp3': 'üéµ', 'wav': 'üéµ', 'flac': 'üéµ', 'aac': 'üéµ',
            'ogg': 'üéµ', 'm4a': 'üéµ',
            
            // ÂéãÁº©Á±ª
            'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶', 'tar': 'üì¶',
            'gz': 'üì¶', 'bz2': 'üì¶',
            
            // ‰ª£Á†ÅÁ±ª
            'js': 'üìú', 'css': 'üìú', 'html': 'üìú', 'php': 'üìú',
            'py': 'üìú', 'java': 'üìú', 'cpp': 'üìú', 'c': 'üìú',
            
            // ÂÖ∂‰ªñ
            'exe': '‚öôÔ∏è', 'dmg': '‚öôÔ∏è', 'app': '‚öôÔ∏è',
            'json': 'üìã', 'xml': 'üìã', 'yml': 'üìã', 'yaml': 'üìã'
        };
        
        return iconMap[ext] || 'üìÑ';
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
    }
    
    showToast(message, type = 'info') {
        if (window.customToast && typeof window.customToast.show === 'function') {
            window.customToast.show(message, type);
        } else {
            // Â§áÁî®ÊñπÊ°àÔºöÂàõÂª∫ÁÆÄÂçïÁöÑtoast
            this.createSimpleToast(message, type);
        }
    }
    
    createSimpleToast(message, type) {
        // ÁßªÈô§Áé∞ÊúâÁöÑtoast
        const existingToast = document.querySelector('.simple-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `simple-toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            animation: slideInRight 0.3s ease-out;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
}

// Ê∑ªÂä†CSSÂä®Áîª
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ÂàùÂßãÂåñÂ∫îÁî®
const app = new App();

// ÂØºÂá∫ÁªôÂÖ∂‰ªñËÑöÊú¨‰ΩøÁî®
window.app = app;