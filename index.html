<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <title>æ–‡ä»¶å‹ç¼©å·¥å…·</title>
    <meta name="description" content="åœ¨çº¿æ–‡ä»¶å‹ç¼©å·¥å…·ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼å‹ç¼©">
    
    <!-- å¼•å…¥å¤–éƒ¨å·¥å…·åº“ -->
    <script src="https://zww2.xiexinbao.com/js/zww_utils.js"></script>
    <script src="https://zww2.xiexinbao.com/js/custom-toast.js"></script>
    <script src="js/zww_uploader.js"></script>
    <script src="https://zww.xiexinbao.com/js/jszip.min.js"></script>
    
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        *::-webkit-scrollbar{display:none;width:0px;height:0px;}
        *::-webkit-scrollbar-corner {display:none;width:0px;height:0px; }
        *::-webkit-resizer{display:none;}
        
        body {
            font-size: 14px;
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            touch-action: manipulation;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            height: 72px;
            text-align: center;
            background: white;
            box-shadow: 0px 0px 4px rgba(14, 19, 24, .07);
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            width: 100%;
            z-index: 1000;
            top: 0;
        }
        
        .header .logo {
            color: #54616c;
            font-size: 24px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 72px 5vw 0;
            min-height: calc(100vh - 112px);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* é¦–é¡µå¤§å¡ç‰‡æ ·å¼ - å‚è€ƒ1.007.gd */
        .upload-card {
            background: white;
            border-radius: 16px;
            padding: clamp(40px, 8vw, 60px) clamp(25px, 5vw, 40px);
            margin-top: clamp(30px, 10vw, 80px);
            max-width: min(750px, 95vw);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            border: none;
            background: transparent;
        }
        
        .upload-area:hover {
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            transform: scale(1.02);
        }
        
        /* éšè—ä¸Šä¼ åŒºåŸŸ */
        .upload-card.hidden {
            display: none;
        }
        
        .upload-title {
            font-size: clamp(24px, 6vw, 32px);
            color: #333;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .upload-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.5;
        }
        
        .upload-button {
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: clamp(12px, 3vw, 16px) clamp(24px, 6vw, 32px);
            font-size: clamp(14px, 4vw, 16px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-button:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .upload-button:active {
            transform: translateY(0);
        }
        
        /* æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ */
        .files-section {
            display: none;
            margin-top: 10px;
        }
        
        .section-title {
            font-size: clamp(16px, 4vw, 18px);
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: clamp(8px, 2vw, 16px);
        }
        
        .file-actions-top {
            display: flex;
            gap: 8px;
            order: 3;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .file-stats {
            font-size: clamp(12px, 3vw, 14px);
            color: #666;
            display: flex;
            gap: clamp(12px, 3vw, 20px);
            order: 2;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        
        /* é¡¶éƒ¨å›¾æ ‡æŒ‰é’® */
        .btn-icon {
            width: clamp(32px, 8vw, 36px);
            height: clamp(32px, 8vw, 36px);
            border: none;
            border-radius: 8px;
            background: #f8f9fa;
            color: #333;
            font-size: clamp(14px, 4vw, 16px);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e9ecef;
        }
        
        .btn-icon:hover {
            background: #e9ecef;
            border-color: #3B82F6;
            transform: translateY(-1px);
        }
        
        .btn-icon:active {
            transform: translateY(0);
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
        }
        
        .file-item:hover {
            background: #e9ecef;
            border-color: #3B82F6;
            transform: translateY(-1px);
        }
        
        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 12px;
        }
        
        .file-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-size: 16px;
            color: #333;
            margin: 0 0 4px 0;
            word-break: break-all;
            line-height: 1.4;
        }
        
        .file-size {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .file-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: #f8f9fa;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e9ecef;
        }
        
        .file-action-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .file-action-btn.delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .file-action-btn.rename:hover {
            background: #ffc107;
            color: white;
            border-color: #ffc107;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #3B82F6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563EB;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-large {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            justify-content: center;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* å‹ç¼©åŒºåŸŸ */
        .compress-section {
            display: none;
            margin-top: 20px;
        }
        
        /* å®¢æœåŒºåŸŸ */
        .customer-service {
            text-align: center;
            background: transparent;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .customer-service p {
            margin: 0;
            font-size: 14px;
            color: #888;
            font-weight: 400;
        }
        
        .customer-service a {
            color: #3B82F6 !important;
            text-decoration: none !important;
            font-weight: 500;
        }
        
        .customer-service a:hover {
            color: #2563EB !important;
            text-decoration: underline !important;
        }
        
        /* å‹ç¼©å¼¹æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .loading-animation {
            margin-bottom: 24px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-title {
            margin: 0 0 12px 0;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        
        .modal-text {
            color: #666;
            font-size: 16px;
            margin: 0;
            line-height: 1.5;
        }
        

    </style>
</head>
<body>
    <!-- å›ºå®šå¤´éƒ¨ -->
    <div class="header">
        <span class="logo">æ–‡ä»¶å‹ç¼©å·¥å…·</span>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-card" id="uploadCard">
            <div class="upload-area" id="uploadArea">
                <div class="upload-title">ä¸Šä¼ æ–‡ä»¶ï¼Œä¸€é”®å‹ç¼©</div>
                <button class="upload-button">
                    <span>ğŸ“</span>
                    ä¸Šä¼ æ–‡ä»¶
                </button>
            </div>
            <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            
        <!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div class="files-section" id="filesSection">
            <div class="section-title">
                <span>å·²é€‰æ–‡ä»¶</span>
                <div class="file-actions-top">
                    <button class="btn-icon" id="addMoreBtn" title="æ·»åŠ æ›´å¤šæ–‡ä»¶">
                        â•
                    </button>
                </div>
                <div class="file-stats">
                    <span>æ•°é‡: <span id="fileCount">0</span></span>
                    <span>å¤§å°: <span id="totalSize">0 B</span></span>
                </div>
            </div>
            
            <div class="file-list" id="fileList">
                <!-- æ–‡ä»¶é¡¹å°†åœ¨æ­¤åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- å‹ç¼©åŒºåŸŸ -->
            <div class="compress-section" id="compressSection">
                <button class="btn btn-success btn-large" id="compressBtn">
                     å¼€å§‹å‹ç¼©
                </button>
            </div>
        </div>
    </div>
    
    <!-- è®¢å•åˆ—è¡¨åŒºåŸŸ -->
    <div class="order-list-section" id="orderListSection" style="display: none;">
        <div class="container">
            <div class="order-list" id="orderList">
                <!-- è®¢å•é¡¹å°†åœ¨æ­¤åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- å®¢æœåŒºåŸŸ -->
    <div class="customer-service">
        <p>é‡åˆ°é—®é¢˜ï¼š<a onclick="callWxkefu()" style="text-decoration:none;color:#3B82F6;cursor:pointer;">ç‚¹æ­¤è”ç³»å®¢æœ</a></p>
    </div>
    
    <!-- å‹ç¼©è¿›åº¦å¼¹æ¡† -->
    <div class="modal" id="compressModal">
        <div class="modal-content">
            <div class="loading-animation">
                <div class="spinner"></div>
            </div>
            <h3 class="modal-title">æ­£åœ¨å‹ç¼©æ–‡ä»¶...</h3>
            <p class="modal-text" id="compressStatus">æ­£åœ¨å¤„ç†æ‚¨çš„æ–‡ä»¶ï¼Œè¯·ç¨å€™</p>
        </div>
    </div>

    <!-- å¼•å…¥æŒ‡çº¹è¯†åˆ«åº“ -->
    <script src="https://caipiao88.oss-cn-hangzhou.aliyuncs.com/cdn/fp/thumbmark.umd.js"></script>
    <script>
        ThumbmarkJS.getFingerprint().then(
            function(fp) {
                window.fp_id = fp;
            }
        );
    </script>

    <!-- ä¸»è¦è„šæœ¬ -->
    <script src="js/analytics.js"></script>
    <script>
        // æ–‡ä»¶å‹ç¼©åº”ç”¨
        class CompressApp {
            constructor() {
                this.selectedFiles = [];
                this.isCompressing = false;
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.setupDragAndDrop();
                console.log('ğŸš€ æ–‡ä»¶å‹ç¼©åº”ç”¨å·²åˆå§‹åŒ–');
                
                // é¡µé¢è®¿é—®ç»Ÿè®¡
                if (window.analytics) {
                    window.analytics.pageView('index');
                }
                
                // å»¶è¿ŸåŠ è½½å†å²è®¢å•
                setTimeout(() => {
                    if (typeof getMyOrders === 'function') {
                        getMyOrders();
                    }
                }, 500);
            }
            
            bindEvents() {
                const uploadArea = document.getElementById('uploadArea');
                const uploadButton = document.querySelector('.upload-button');
                const fileInput = document.getElementById('fileInput');
                const addMoreBtn = document.getElementById('addMoreBtn');
                const compressBtn = document.getElementById('compressBtn');
                
                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                uploadArea.addEventListener('click', () => {
                    if (window.analytics) {
                        window.analytics.buttonClick('upload_area_click');
                    }
                    fileInput.click();
                });
                
                // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                if (uploadButton) {
                    uploadButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜²æ­¢å†’æ³¡åˆ°çˆ¶å…ƒç´ 
                        if (window.analytics) {
                            window.analytics.buttonClick('upload_button_click');
                        }
                        fileInput.click();
                    });
                }
                
                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files, 'file_input');
                });
                
                // æŒ‰é’®äº‹ä»¶
                if (addMoreBtn) {
                    addMoreBtn.addEventListener('click', () => {
                        if (window.analytics) {
                            window.analytics.buttonClick('add_more_files');
                        }
                        fileInput.click();
                    });
                }
                
                compressBtn.addEventListener('click', () => {
                    if (window.analytics) {
                        window.analytics.buttonClick('start_compress');
                    }
                    this.startCompress();
                });
            }
            
            setupDragAndDrop() {
                const uploadArea = document.getElementById('uploadArea');
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if (window.analytics) {
                            window.analytics.fileDragDrop(files.length, this.calculateTotalSize(files));
                        }
                        this.handleFileSelect(files, 'drag_drop');
                    }
                });
            }
            
            handleFileSelect(files, source = 'unknown') {
                if (files.length === 0) return;
                
                console.log(`ğŸ“ é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶ï¼Œæ¥æº: ${source}`);
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é€‰æ‹©ï¼Œæ›¿æ¢æ–‡ä»¶ï¼›å¦‚æœæ˜¯æ·»åŠ æ›´å¤šï¼Œåˆå¹¶æ–‡ä»¶
                if (source === 'file_input' && this.selectedFiles.length === 0) {
                    this.selectedFiles = Array.from(files);
                } else {
                    // æ·»åŠ æ–°æ–‡ä»¶ï¼Œé¿å…é‡å¤
                    const newFiles = Array.from(files).filter(newFile => 
                        !this.selectedFiles.some(existingFile => 
                            existingFile.name === newFile.name && existingFile.size === newFile.size
                        )
                    );
                    this.selectedFiles = this.selectedFiles.concat(newFiles);
                    
                    if (newFiles.length < files.length) {
                        this.showToast(`å·²è¿‡æ»¤ ${files.length - newFiles.length} ä¸ªé‡å¤æ–‡ä»¶`);
                    }
                }
                    
                    // æ–‡ä»¶é€‰æ‹©ç»Ÿè®¡
                    if (window.analytics) {
                        const totalSize = this.getTotalSize();
                        window.analytics.fileSelect(this.selectedFiles.length, totalSize);
                    }
                
                this.updateDisplay();
                this.showToast(`âœ… å·²é€‰æ‹© ${this.selectedFiles.length} ä¸ªæ–‡ä»¶`);
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
                document.getElementById('fileInput').value = '';
            }
            
            updateDisplay() {
                const uploadCard = document.getElementById('uploadCard');
                const filesSection = document.getElementById('filesSection');
                const compressSection = document.getElementById('compressSection');
                const fileCount = document.getElementById('fileCount');
                const totalSize = document.getElementById('totalSize');
                
                if (this.selectedFiles.length === 0) {
                    // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸï¼Œéšè—æ–‡ä»¶åŒºåŸŸ
                    uploadCard.classList.remove('hidden');
                    filesSection.style.display = 'none';
                return;
            }
            
                // éšè—ä¸Šä¼ åŒºåŸŸï¼Œæ˜¾ç¤ºæ–‡ä»¶åŒºåŸŸ
                uploadCard.classList.add('hidden');
                filesSection.style.display = 'block';
                compressSection.style.display = 'block';
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                fileCount.textContent = this.selectedFiles.length;
                totalSize.textContent = this.formatFileSize(this.getTotalSize());
                
                // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
                this.renderFileList();
            }
            
            renderFileList() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                
                this.selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">${this.getFileIcon(file.name)}</div>
                            <div class="file-details">
                                <h4 class="file-name" title="${file.name}">${file.name}</h4>
                                <p class="file-size">${this.formatFileSize(file.size)}</p>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn rename" title="é‡å‘½å" onclick="app.renameFile(${index})">
                                âœï¸
                            </button>
                            <button class="file-action-btn delete" title="åˆ é™¤æ–‡ä»¶" onclick="app.removeFile(${index})">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
            }
            
            removeFile(index) {
                if (index < 0 || index >= this.selectedFiles.length) return;
                
                const file = this.selectedFiles[index];
                console.log(`ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: ${file.name}`);
                
                // æ–‡ä»¶åˆ é™¤ç»Ÿè®¡
                if (window.analytics) {
                    window.analytics.fileAction('remove', file.name);
                }
                
                this.selectedFiles.splice(index, 1);
                this.updateDisplay();
                this.showToast(`ğŸ—‘ï¸ å·²åˆ é™¤ ${file.name}`);
            }
            
            renameFile(index) {
                if (index < 0 || index >= this.selectedFiles.length) return;
                
                const file = this.selectedFiles[index];
                const currentName = file.name;
                const dotIndex = currentName.lastIndexOf('.');
                const nameWithoutExt = dotIndex > 0 ? currentName.substring(0, dotIndex) : currentName;
                const extension = dotIndex > 0 ? currentName.substring(dotIndex) : '';
                
                const newName = prompt('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶åï¼ˆä¸åŒ…å«åç¼€ï¼‰:', nameWithoutExt);
                
                if (newName && newName.trim() && newName.trim() !== nameWithoutExt) {
                    const finalName = newName.trim() + extension;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤æ–‡ä»¶å
                    const hasDuplicate = this.selectedFiles.some((f, i) => 
                        i !== index && f.name === finalName
                    );
                    
                    if (hasDuplicate) {
                        this.showToast('âŒ æ–‡ä»¶åå·²å­˜åœ¨');
                        return;
                    }
                    
                    // åˆ›å»ºæ–°çš„Fileå¯¹è±¡
                    const newFile = new File([file], finalName, { type: file.type });
                    this.selectedFiles[index] = newFile;
                    
                    console.log(`âœï¸ æ–‡ä»¶é‡å‘½å: ${currentName} â†’ ${finalName}`);
                    
                    // æ–‡ä»¶é‡å‘½åç»Ÿè®¡
                    if (window.analytics) {
                        window.analytics.fileAction('rename', finalName);
                    }
                    
                    this.updateDisplay();
                    this.showToast(`âœï¸ å·²é‡å‘½åä¸º ${finalName}`);
                }
            }
            
            clearAllFiles() {
                if (this.selectedFiles.length === 0) return;
                
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
                    const count = this.selectedFiles.length;
                    console.log(`ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶: ${count} ä¸ª`);
                    
                    // æ¸…ç©ºç»Ÿè®¡
                    if (window.analytics) {
                        window.analytics.fileAction('clear_all');
                    }
                    
                    this.selectedFiles = [];
                    this.updateDisplay();
                    this.showToast(`ğŸ§¹ å·²æ¸…ç©º ${count} ä¸ªæ–‡ä»¶`);
                }
            }
            
            async startCompress() {
                if (this.selectedFiles.length === 0) {
                    this.showToast('âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                    return;
                }
                
                if (this.isCompressing) {
                    this.showToast('âš ï¸ æ­£åœ¨å‹ç¼©ä¸­ï¼Œè¯·ç¨å€™');
                return;
            }
            
                console.log(`ğŸš€ å¼€å§‹å‹ç¼© ${this.selectedFiles.length} ä¸ªæ–‡ä»¶`);
                
                this.isCompressing = true;
                
                // æ˜¾ç¤ºå‹ç¼©å¼¹æ¡†
                const modal = document.getElementById('compressModal');
                modal.style.display = 'flex';
                
                // å‹ç¼©å¼€å§‹ç»Ÿè®¡
                if (window.analytics) {
                    window.analytics.compressStart(this.selectedFiles.length, this.getTotalSize());
                }
                
                const startTime = Date.now();
                
                try {
                    // æ£€æŸ¥JSZipæ˜¯å¦åŠ è½½
                    if (typeof JSZip === 'undefined') {
                        throw new Error('å‹ç¼©åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                    
                    // åˆ›å»ºJSZipå®ä¾‹
                    const zip = new JSZip();
                    
                    // æ·»åŠ æ–‡ä»¶åˆ°zip
                    for (let i = 0; i < this.selectedFiles.length; i++) {
                        const file = this.selectedFiles[i];
                        const status = document.getElementById('compressStatus');
                        status.textContent = `æ­£åœ¨æ·»åŠ æ–‡ä»¶: ${file.name} (${i + 1}/${this.selectedFiles.length})`;
                        
                        // å¤„ç†æ–‡ä»¶åå†²çª
                        let fileName = file.name;
                        let counter = 1;
                        while (zip.file(fileName)) {
                            const nameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
                            const ext = file.name.substring(file.name.lastIndexOf('.'));
                            fileName = `${nameWithoutExt}_${counter}${ext}`;
                            counter++;
                        }
                        
                        zip.file(fileName, file);
                        console.log(`ğŸ“ å·²æ·»åŠ æ–‡ä»¶: ${fileName} (${this.formatFileSize(file.size)})`);
                        
                        // å°å»¶è¿Ÿè®©UIæ›´æ–°
                        await this.sleep(50);
                    }
                    
                    const status = document.getElementById('compressStatus');
                    status.textContent = 'æ­£åœ¨ç”Ÿæˆå‹ç¼©åŒ…...';
                    
                    // ç”Ÿæˆzipæ–‡ä»¶
                    const zipBlob = await zip.generateAsync({
                        type: "blob",
                        compression: "DEFLATE",
                        compressionOptions: { level: 6 }
                    }, (metadata) => {
                        // æ›´æ–°å‹ç¼©è¿›åº¦
                        const progress = Math.round(metadata.percent);
                        status.textContent = `æ­£åœ¨å‹ç¼©... ${progress}%`;
                    });
                    
                    const duration = Date.now() - startTime;
                    
                    // ä¿å­˜å‹ç¼©ç»“æœ
                    const compressResult = {
                        fileName: `compressed_files_${Date.now()}`,
                        originalSize: this.getTotalSize(),
                        compressedSize: zipBlob.size,
                        fileCount: this.selectedFiles.length,
                        timestamp: Date.now(),
                        duration: duration
                    };
                    
                    console.log('âœ… å‹ç¼©å®Œæˆ:', compressResult);
                    
                    // å­˜å‚¨ç»“æœåˆ°å…¨å±€å˜é‡å’ŒsessionStorage
                    window.compressedBlob = zipBlob;
                    sessionStorage.setItem('compressResult', JSON.stringify(compressResult));
                    
                    // åˆ›å»ºè®¢å•ï¼ˆå¦‚æœæœ‰APIï¼‰
                    try {
                        await this.createOrder(compressResult);
                    } catch (orderError) {
                        console.error('åˆ›å»ºè®¢å•å¤±è´¥:', orderError);
                        // ä¸å½±å“å‹ç¼©æµç¨‹
                    }
                    
                    // å‹ç¼©æˆåŠŸç»Ÿè®¡
                    if (window.analytics) {
                        window.analytics.compressComplete(compressResult.originalSize, compressResult.compressedSize, this.selectedFiles.length);
                    }
                    
                    // éšè—å¼¹æ¡†
                    modal.style.display = 'none';
                    this.isCompressing = false;
                    
                     window.location.href = 'result.html';
            } catch (error) {
                    console.error('âŒ å‹ç¼©å¤±è´¥:', error);
                    
                    // å‹ç¼©å¤±è´¥ç»Ÿè®¡
                    if (window.analytics) {
                        window.analytics.compressError(error);
                    }
                    
                    // éšè—å¼¹æ¡†
                    modal.style.display = 'none';
                    this.isCompressing = false;
                    
                    this.showToast('âŒ å‹ç¼©å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            }
            
            async createOrder(compressResult) {
                try {
                    const orderData = {
                        file_count: compressResult.fileCount,
                        original_size: compressResult.originalSize,
                        compressed_size: compressResult.compressedSize,
                        compression_ratio: ((compressResult.originalSize - compressResult.compressedSize) / compressResult.originalSize * 100).toFixed(2),
                        timestamp: compressResult.timestamp,
                        user_agent: navigator.userAgent,
                        source: 'h5_compressor_unified'
                    };
                    
                    const response = await fetch('http://p.xiexinbao.com/zww_order/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData),
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const orderId = result.orderId || result.id || Date.now();
                        sessionStorage.setItem('orderId', orderId);
                        console.log('ğŸ“ è®¢å•åˆ›å»ºæˆåŠŸ:', orderId);
                        
                        // è®¢å•åˆ›å»ºæˆåŠŸç»Ÿè®¡
                        if (window.analytics) {
                            window.analytics.track('order_created');
                        }
                    } else {
                        console.log('âš ï¸ è®¢å•åˆ›å»ºå¤±è´¥:', response.status);
                    }
                } catch (error) {
                    console.log('âš ï¸ è®¢å•åˆ›å»ºé”™è¯¯:', error.message);
                    // ä¸å½±å“å‹ç¼©æµç¨‹ï¼Œåªè®°å½•æ—¥å¿—
                }
            }
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // å·¥å…·æ–¹æ³•
            getTotalSize() {
                return this.selectedFiles.reduce((sum, file) => sum + file.size, 0);
            }
            
            calculateTotalSize(files) {
                return Array.from(files).reduce((sum, file) => sum + file.size, 0);
            }
            
            getFileTypes(files) {
            const types = {};
            files.forEach(file => {
                    const ext = this.getFileExtension(file.name);
                types[ext] = (types[ext] || 0) + 1;
            });
            return types;
        }
        
            getFileExtension(fileName) {
            return fileName.split('.').pop().toLowerCase() || 'unknown';
        }
        
            getFileIcon(fileName) {
                const ext = fileName.split('.').pop().toLowerCase();
                const iconMap = {
                    // æ–‡æ¡£ç±»
                    'pdf': 'ğŸ“„',
                    'doc': 'ğŸ“', 'docx': 'ğŸ“',
                    'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'csv': 'ğŸ“Š',
                    'ppt': 'ğŸ“ˆ', 'pptx': 'ğŸ“ˆ',
                    'txt': 'ğŸ“ƒ', 'rtf': 'ğŸ“ƒ',
                    
                    // å›¾ç‰‡ç±»
                    'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                    'bmp': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸', 'webp': 'ğŸ–¼ï¸', 'ico': 'ğŸ–¼ï¸',
                    
                    // è§†é¢‘ç±»
                    'mp4': 'ğŸ¥', 'avi': 'ğŸ¥', 'mov': 'ğŸ¥', 'wmv': 'ğŸ¥',
                    'flv': 'ğŸ¥', 'mkv': 'ğŸ¥', 'webm': 'ğŸ¥',
                    
                    // éŸ³é¢‘ç±»
                    'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ', 'aac': 'ğŸµ',
                    'ogg': 'ğŸµ', 'm4a': 'ğŸµ',
                    
                    // å‹ç¼©ç±»
                    'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦', 'tar': 'ğŸ“¦',
                    'gz': 'ğŸ“¦', 'bz2': 'ğŸ“¦',
                    
                    // ä»£ç ç±»
                    'js': 'ğŸ“œ', 'css': 'ğŸ“œ', 'html': 'ğŸ“œ', 'php': 'ğŸ“œ',
                    'py': 'ğŸ“œ', 'java': 'ğŸ“œ', 'cpp': 'ğŸ“œ', 'c': 'ğŸ“œ',
                    
                    // å…¶ä»–
                    'exe': 'âš™ï¸', 'dmg': 'âš™ï¸', 'app': 'âš™ï¸',
                    'json': 'ğŸ“‹', 'xml': 'ğŸ“‹', 'yml': 'ğŸ“‹', 'yaml': 'ğŸ“‹'
                };
                
                return iconMap[ext] || 'ğŸ“„';
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
            }
            
            showToast(message, type = 'info') {
            if (window.popToast && typeof window.popToast === 'function') {
                    window.popToast({title: message, timeout: 2000});
            } else {
                    console.log(message); // fallbackåˆ°æ§åˆ¶å°è¾“å‡º
                }
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        const app = new CompressApp();
        window.app = app;
        
        // å…¨å±€å˜é‡åˆå§‹åŒ–
        var admin_uid = getParamsFromUrl('admin_uid') || localStorage.getItem('admin_uid') || '';
        localStorage.setItem('admin_uid', admin_uid);
        
        // å®¢æœåŠŸèƒ½
        async function callWxkefu() {
            var user_id = getUserId() || window.fp_id || '';
            var wx_service_link = `https://work.weixin.qq.com/kfid/kfc7d846fca34c6ca69?enc_scene=ENCettynNzrtEHbKDpamvHQPpMev884BwvoYrk3i2CQymZ&scene_param=${user_id}`;
            
            const isWx = /micromessenger/i.test(navigator.userAgent);
            if (isWx) {
                window.location.href = wx_service_link;
                return;
            }
            
            // éå¾®ä¿¡ç¯å¢ƒå¤„ç†
            const hasTouchScreen = ('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0);
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isMobile = isAndroid || isIOS || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            let deviceType = 'pc';
            if (hasTouchScreen && isMobile) {
                if (isAndroid) {
                    deviceType = 'android';
                } else if (isIOS) {
                    deviceType = 'iphone';
                } else {
                    deviceType = 'android';
                }
            }

            if (deviceType === 'pc') {
                // PCç«¯å¾®ä¿¡è·³è½¬é“¾æ¥å¤„ç†
                const parsedUrl = new URL(wx_service_link);
                const kfid = parsedUrl.pathname.split('/')[2];
                const encScene = parsedUrl.searchParams.get('enc_scene');
                const sceneParam = parsedUrl.searchParams.get('scene_param');
                const newUrl = new URL('weixin://jumptokfchat/');
                newUrl.searchParams.append('kfid', kfid);
                newUrl.searchParams.append('scene', '50');
                const extParams = new URLSearchParams();
                if (encScene) {
                    extParams.append('enc_scene', encScene);
                }
                if (sceneParam) {
                    extParams.append('scene_param', sceneParam);
                }
                extParams.append('refkey', '');
                newUrl.searchParams.append('ext_params', extParams.toString());
                wx_service_link = newUrl.toString();
            } else {
                // ç§»åŠ¨ç«¯å¤„ç†
                try {
                    const getProtocol = () => window.location.protocol.indexOf('https') > -1 ? 'https:' : 'http:';
                    const response = await fetch(getProtocol() + '//www.xiexinbao.com/txb/wxticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: `kfurl=${encodeURIComponent(wx_service_link)}`
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const _kefu_url = await response.text();
                    if (_kefu_url.startsWith('weixin://')) {
                        wx_service_link = _kefu_url;
                    }
                } catch (error) {
                    console.error("è·å–å¾®ä¿¡å®¢æœé“¾æ¥å¤±è´¥:", error);
                }
            }
            
            window.location.href = wx_service_link;
        }
        
        function getParamsFromUrl(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        
        function getUserId() {
            return localStorage.getItem('user_id') || '';
        }
        
        // è·å–åè®®
        function getProtocol() {
            return window.location.protocol.indexOf('https') > -1 ? 'https:' : 'http:';
        }
        
        // HTTP POST è¯·æ±‚å‡½æ•°
        function http_post(options) {
            const { url, data, callback } = options;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data),
                mode: 'cors'
            })
            .then(response => response.text())
            .then(callback)
            .catch(error => {
                console.error('HTTPè¯·æ±‚å¤±è´¥:', error);
                if (callback) callback('{"list":[]}'); // è¿”å›ç©ºåˆ—è¡¨ä½œä¸ºfallback
            });
        }
        
        // æ•°å­—è½¬62è¿›åˆ¶
        function to62(num) {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            if (num === 0) return '0';
            while (num > 0) {
                result = chars[num % 62] + result;
                num = Math.floor(num / 62);
            }
            return result;
        }
        
        // è·å–æˆ‘çš„è®¢å•åˆ—è¡¨
        function getMyOrders() {
            const orderListSection = document.getElementById('orderListSection');
            const orderList = document.getElementById('orderList');
            
            http_post({
                url: getProtocol() + '//p.xiexinbao.com/zww_order/mylist',
                data: {
                    user_id: getUserId() || window.fp_id || '',
                    openid: '',
                    limit: 50
                },
                callback: function(html) {
                    try {
                        const result = JSON.parse(html);
                        let tpls = result.list || [];

                        // è¿‡æ»¤å‡º data_out_temp ä»¥ 'http' å¼€å¤´çš„è®¢å•
                        tpls = tpls.filter(function(item) {
                            return item.data_out_temp && item.data_out_temp.startsWith('http');
                        });

                        // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åº
                        tpls.sort(function(a, b) {
                            return parseInt(b.ctime) - parseInt(a.ctime);
                        });

                        if (tpls.length > 0) {
                            // æ˜¾ç¤ºè®¢å•åˆ—è¡¨åŒºåŸŸ
                            orderListSection.style.display = 'block';
                            
                            let orderListHtml = '<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;"><h3 style="font-size: 18px; color: #333; margin: 0;">å†å²è®°å½•</h3><span style="font-size: 12px; color: #888;">ä»…ä¿ç•™24å°æ—¶, è¯·æå‰ä¸‹è½½å¤‡ä»½</span></div>';
                            orderListHtml += '<div class="order-items">';
                            
                            tpls.forEach(function(item) {
                                // ä»è®¢å•æ•°æ®ä¸­è·å–å‹ç¼©åŒ…ä¿¡æ¯
                                let fileName = 'å‹ç¼©åŒ….zip';
                                let fileCount = 0;
                                
                                try {
                                    const dataIn = JSON.parse(item.data_in || '{}');
                                    if (dataIn.file_count) {
                                        fileCount = dataIn.file_count;
                                        fileName = `å‹ç¼©åŒ…(${fileCount}ä¸ªæ–‡ä»¶).zip`;
                                    }
                                } catch (e) {
                                    console.error('è§£æè®¢å•æ•°æ®å¤±è´¥:', e);
                                }
                                
                                const payCallback = `result.html?order_id=${item.id}`;
                                
                                orderListHtml += '<div class="order-item" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                                orderListHtml += '<div class="item-icon" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #3B82F6; color: white; font-weight: bold; font-size: 12px;">';
                                orderListHtml += 'ZIP';
                                orderListHtml += '</div>';
                                orderListHtml += '<div class="file-info" style="flex: 1; overflow: hidden;">';
                                orderListHtml += '<div class="file-name" style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + fileName + '</div>';
                                if (fileCount > 0) {
                                    orderListHtml += '<div class="file-count" style="font-size: 12px; color: #666; margin-top: 2px;">åŒ…å« ' + fileCount + ' ä¸ªæ–‡ä»¶</div>';
                                }
                                orderListHtml += '</div>';
                                orderListHtml += '<a href="' + payCallback + '" class="download-btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block;">ä¸‹è½½</a>';
                                orderListHtml += '</div>';
                            });
                            
                            orderListHtml += '</div>';
                            orderList.innerHTML = orderListHtml;
                            
                            console.log(`ğŸ“‹ åŠ è½½äº† ${tpls.length} ä¸ªå†å²è®¢å•`);
                        } else {
                            // æ²¡æœ‰è®¢å•æ—¶éšè—åŒºåŸŸ
                            orderListSection.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('è§£æè®¢å•åˆ—è¡¨å¤±è´¥:', error);
                        orderListSection.style.display = 'none';
                    }
                }
            });
        }
        
        console.log('ğŸš€ æ–‡ä»¶å‹ç¼©å·¥å…·å·²åŠ è½½å®Œæˆ');
    </script>

    <!-- ç»Ÿè®¡è„šæœ¬ -->
    <script>
        (function() {
            var cswtj_id = '';
            var _plat = window.location.hostname;
            var _w = 'index.html';
            if (typeof localStorage == "object") {
                cswtj_id = localStorage.getItem('cswtj_id') || ''; 
            }
            function _loadtj(retries) {
                var hm = document.createElement("script");
                hm.src = getProtocol()+"//log.xiexinbao.com/cswtj.js?plat="+_plat+"&w="+_w+"&cswtj_id="+cswtj_id;
                hm.onload = function() {};
                hm.onerror = function() {
                    if (retries > 0) {
                        _loadtj(retries - 1);
                    }
                    console.log('cswtj.js load error!')
                };
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            }
            _loadtj(1);
        })();
    </script>
</body>
</html>