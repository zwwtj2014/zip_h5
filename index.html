<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <title>文件压缩工具</title>
    <meta name="description" content="在线文件压缩工具，支持多种文件格式压缩">
    
    <!-- 引入外部工具库 -->
    <script src="https://zww2.xiexinbao.com/js/zww_utils.js"></script>
    <script src="https://zww2.xiexinbao.com/js/custom-toast.js"></script>
    <script src="js/zww_uploader.js"></script>
    <script src="https://zww.xiexinbao.com/js/jszip.min.js"></script>
    
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        *::-webkit-scrollbar{display:none;width:0px;height:0px;}
        *::-webkit-scrollbar-corner {display:none;width:0px;height:0px; }
        *::-webkit-resizer{display:none;}
        
        body {
            font-size: 14px;
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            touch-action: manipulation;
        }
        
        /* 头部样式 */
        .header {
            height: 72px;
            text-align: center;
            background: white;
            box-shadow: 0px 0px 4px rgba(14, 19, 24, .07);
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            width: 100%;
            z-index: 1000;
            top: 0;
        }
        
        .header .logo {
            color: #54616c;
            font-size: 24px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        /* 主容器 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 72px 5vw 0;
            min-height: calc(100vh - 112px);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* 首页大卡片样式 - 参考1.007.gd */
        .upload-card {
            background: white;
            border-radius: 16px;
            padding: clamp(40px, 8vw, 60px) clamp(25px, 5vw, 40px);
            margin-top: clamp(30px, 10vw, 80px);
            max-width: min(750px, 95vw);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* 文件上传区域 */
        .upload-area {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            border: none;
            background: transparent;
        }
        
        .upload-area:hover {
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            transform: scale(1.02);
        }
        
        /* 隐藏上传区域 */
        .upload-card.hidden {
            display: none;
        }
        
        .upload-title {
            font-size: clamp(24px, 6vw, 32px);
            color: #333;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .upload-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.5;
        }
        
        .upload-button {
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: clamp(12px, 3vw, 16px) clamp(24px, 6vw, 32px);
            font-size: clamp(14px, 4vw, 16px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-button:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .upload-button:active {
            transform: translateY(0);
        }
        
        /* 文件列表区域 */
        .files-section {
            display: none;
            margin-top: 10px;
        }
        
        .section-title {
            font-size: clamp(16px, 4vw, 18px);
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: clamp(8px, 2vw, 16px);
        }
        
        .file-actions-top {
            display: flex;
            gap: 8px;
            order: 3;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .file-stats {
            font-size: clamp(12px, 3vw, 14px);
            color: #666;
            display: flex;
            gap: clamp(12px, 3vw, 20px);
            order: 2;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        
        /* 顶部图标按钮 */
        .btn-icon {
            width: clamp(32px, 8vw, 36px);
            height: clamp(32px, 8vw, 36px);
            border: none;
            border-radius: 8px;
            background: #f8f9fa;
            color: #333;
            font-size: clamp(14px, 4vw, 16px);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e9ecef;
        }
        
        .btn-icon:hover {
            background: #e9ecef;
            border-color: #3B82F6;
            transform: translateY(-1px);
        }
        
        .btn-icon:active {
            transform: translateY(0);
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
        }
        
        .file-item:hover {
            background: #e9ecef;
            border-color: #3B82F6;
            transform: translateY(-1px);
        }
        
        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 12px;
        }
        
        .file-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-size: 16px;
            color: #333;
            margin: 0 0 4px 0;
            word-break: break-all;
            line-height: 1.4;
        }
        
        .file-size {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .file-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: #f8f9fa;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e9ecef;
        }
        
        .file-action-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .file-action-btn.delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .file-action-btn.rename:hover {
            background: #ffc107;
            color: white;
            border-color: #ffc107;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #3B82F6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563EB;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-large {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            justify-content: center;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* 压缩区域 */
        .compress-section {
            display: none;
            margin-top: 20px;
        }
        
        /* 客服区域 */
        .customer-service {
            text-align: center;
            background: transparent;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .customer-service p {
            margin: 0;
            font-size: 14px;
            color: #888;
            font-weight: 400;
        }
        
        .customer-service a {
            color: #3B82F6 !important;
            text-decoration: none !important;
            font-weight: 500;
        }
        
        .customer-service a:hover {
            color: #2563EB !important;
            text-decoration: underline !important;
        }
        
        /* 压缩弹框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .loading-animation {
            margin-bottom: 24px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-title {
            margin: 0 0 12px 0;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        
        .modal-text {
            color: #666;
            font-size: 16px;
            margin: 0;
            line-height: 1.5;
        }
        

    </style>
</head>
<body>
    <!-- 固定头部 -->
    <div class="header">
        <span class="logo">文件压缩工具</span>
    </div>

    <!-- 主容器 -->
    <div class="container">
        <!-- 文件上传区域 -->
        <div class="upload-card" id="uploadCard">
            <div class="upload-area" id="uploadArea">
                <div class="upload-title">上传文件，一键压缩</div>
                <button class="upload-button">
                    <span>📁</span>
                    上传文件
                </button>
            </div>
            <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            
        <!-- 文件列表区域 -->
        <div class="files-section" id="filesSection">
            <div class="section-title">
                <span>已选文件</span>
                <div class="file-actions-top">
                    <button class="btn-icon" id="addMoreBtn" title="添加更多文件">
                        ➕
                    </button>
                </div>
                <div class="file-stats">
                    <span>数量: <span id="fileCount">0</span></span>
                    <span>大小: <span id="totalSize">0 B</span></span>
                </div>
            </div>
            
            <div class="file-list" id="fileList">
                <!-- 文件项将在此动态生成 -->
            </div>
            
            <!-- 压缩区域 -->
            <div class="compress-section" id="compressSection">
                <button class="btn btn-success btn-large" id="compressBtn">
                     开始压缩
                </button>
            </div>
        </div>
    </div>
    
    <!-- 订单列表区域 -->
    <div class="order-list-section" id="orderListSection" style="display: none;">
        <div class="container">
            <div class="order-list" id="orderList">
                <!-- 订单项将在此动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 客服区域 -->
    <div class="customer-service">
        <p>遇到问题：<a onclick="callWxkefu()" style="text-decoration:none;color:#3B82F6;cursor:pointer;">点此联系客服</a></p>
    </div>
    
    <!-- 压缩进度弹框 -->
    <div class="modal" id="compressModal">
        <div class="modal-content">
            <div class="loading-animation">
                <div class="spinner"></div>
            </div>
            <h3 class="modal-title">正在压缩文件...</h3>
            <p class="modal-text" id="compressStatus">正在处理您的文件，请稍候</p>
        </div>
    </div>

    <!-- 引入指纹识别库 -->
    <script src="https://caipiao88.oss-cn-hangzhou.aliyuncs.com/cdn/fp/thumbmark.umd.js"></script>
    <script>
        ThumbmarkJS.getFingerprint().then(
            function(fp) {
                window.fp_id = fp;
            }
        );
    </script>

    <!-- 主要脚本 -->
    <script src="js/analytics.js"></script>
    <script>
        // 文件压缩应用
        class CompressApp {
            constructor() {
                this.selectedFiles = [];
                this.isCompressing = false;
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.setupDragAndDrop();
                console.log('🚀 文件压缩应用已初始化');
                
                // 页面访问统计
                if (window.analytics) {
                    window.analytics.pageView('index');
                }
                
                // 延迟加载历史订单
                setTimeout(() => {
                    if (typeof getMyOrders === 'function') {
                        getMyOrders();
                    }
                }, 500);
            }
            
            bindEvents() {
                const uploadArea = document.getElementById('uploadArea');
                const uploadButton = document.querySelector('.upload-button');
                const fileInput = document.getElementById('fileInput');
                const addMoreBtn = document.getElementById('addMoreBtn');
                const compressBtn = document.getElementById('compressBtn');
                
                // 文件选择事件
                uploadArea.addEventListener('click', () => {
                    if (window.analytics) {
                        window.analytics.buttonClick('upload_area_click');
                    }
                    fileInput.click();
                });
                
                // 上传按钮点击事件
                if (uploadButton) {
                    uploadButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // 防止冒泡到父元素
                        if (window.analytics) {
                            window.analytics.buttonClick('upload_button_click');
                        }
                        fileInput.click();
                    });
                }
                
                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files, 'file_input');
                });
                
                // 按钮事件
                if (addMoreBtn) {
                    addMoreBtn.addEventListener('click', () => {
                        if (window.analytics) {
                            window.analytics.buttonClick('add_more_files');
                        }
                        fileInput.click();
                    });
                }
                
                compressBtn.addEventListener('click', () => {
                    if (window.analytics) {
                        window.analytics.buttonClick('start_compress');
                    }
                    this.startCompress();
                });
            }
            
            setupDragAndDrop() {
                const uploadArea = document.getElementById('uploadArea');
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if (window.analytics) {
                            window.analytics.fileDragDrop(files.length, this.calculateTotalSize(files));
                        }
                        this.handleFileSelect(files, 'drag_drop');
                    }
                });
            }
            
            handleFileSelect(files, source = 'unknown') {
                if (files.length === 0) return;
                
                console.log(`📁 选择了 ${files.length} 个文件，来源: ${source}`);
                
                // 如果是第一次选择，替换文件；如果是添加更多，合并文件
                if (source === 'file_input' && this.selectedFiles.length === 0) {
                    this.selectedFiles = Array.from(files);
                } else {
                    // 添加新文件，避免重复
                    const newFiles = Array.from(files).filter(newFile => 
                        !this.selectedFiles.some(existingFile => 
                            existingFile.name === newFile.name && existingFile.size === newFile.size
                        )
                    );
                    this.selectedFiles = this.selectedFiles.concat(newFiles);
                    
                    if (newFiles.length < files.length) {
                        this.showToast(`已过滤 ${files.length - newFiles.length} 个重复文件`);
                    }
                }
                    
                    // 文件选择统计
                    if (window.analytics) {
                        const totalSize = this.getTotalSize();
                        window.analytics.fileSelect(this.selectedFiles.length, totalSize);
                    }
                
                this.updateDisplay();
                this.showToast(`✅ 已选择 ${this.selectedFiles.length} 个文件`);
                
                // 清空文件输入框，允许重复选择相同文件
                document.getElementById('fileInput').value = '';
            }
            
            updateDisplay() {
                const uploadCard = document.getElementById('uploadCard');
                const filesSection = document.getElementById('filesSection');
                const compressSection = document.getElementById('compressSection');
                const fileCount = document.getElementById('fileCount');
                const totalSize = document.getElementById('totalSize');
                
                if (this.selectedFiles.length === 0) {
                    // 显示上传区域，隐藏文件区域
                    uploadCard.classList.remove('hidden');
                    filesSection.style.display = 'none';
                return;
            }
            
                // 隐藏上传区域，显示文件区域
                uploadCard.classList.add('hidden');
                filesSection.style.display = 'block';
                compressSection.style.display = 'block';
                
                // 更新统计信息
                fileCount.textContent = this.selectedFiles.length;
                totalSize.textContent = this.formatFileSize(this.getTotalSize());
                
                // 渲染文件列表
                this.renderFileList();
            }
            
            renderFileList() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                
                this.selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">${this.getFileIcon(file.name)}</div>
                            <div class="file-details">
                                <h4 class="file-name" title="${file.name}">${file.name}</h4>
                                <p class="file-size">${this.formatFileSize(file.size)}</p>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn rename" title="重命名" onclick="app.renameFile(${index})">
                                ✏️
                            </button>
                            <button class="file-action-btn delete" title="删除文件" onclick="app.removeFile(${index})">
                                🗑️
                            </button>
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
            }
            
            removeFile(index) {
                if (index < 0 || index >= this.selectedFiles.length) return;
                
                const file = this.selectedFiles[index];
                console.log(`🗑️ 删除文件: ${file.name}`);
                
                // 文件删除统计
                if (window.analytics) {
                    window.analytics.fileAction('remove', file.name);
                }
                
                this.selectedFiles.splice(index, 1);
                this.updateDisplay();
                this.showToast(`🗑️ 已删除 ${file.name}`);
            }
            
            renameFile(index) {
                if (index < 0 || index >= this.selectedFiles.length) return;
                
                const file = this.selectedFiles[index];
                const currentName = file.name;
                const dotIndex = currentName.lastIndexOf('.');
                const nameWithoutExt = dotIndex > 0 ? currentName.substring(0, dotIndex) : currentName;
                const extension = dotIndex > 0 ? currentName.substring(dotIndex) : '';
                
                const newName = prompt('请输入新的文件名（不包含后缀）:', nameWithoutExt);
                
                if (newName && newName.trim() && newName.trim() !== nameWithoutExt) {
                    const finalName = newName.trim() + extension;
                    
                    // 检查是否有重复文件名
                    const hasDuplicate = this.selectedFiles.some((f, i) => 
                        i !== index && f.name === finalName
                    );
                    
                    if (hasDuplicate) {
                        this.showToast('❌ 文件名已存在');
                        return;
                    }
                    
                    // 创建新的File对象
                    const newFile = new File([file], finalName, { type: file.type });
                    this.selectedFiles[index] = newFile;
                    
                    console.log(`✏️ 文件重命名: ${currentName} → ${finalName}`);
                    
                    // 文件重命名统计
                    if (window.analytics) {
                        window.analytics.fileAction('rename', finalName);
                    }
                    
                    this.updateDisplay();
                    this.showToast(`✏️ 已重命名为 ${finalName}`);
                }
            }
            
            clearAllFiles() {
                if (this.selectedFiles.length === 0) return;
                
                if (confirm('确定要清空所有文件吗？')) {
                    const count = this.selectedFiles.length;
                    console.log(`🧹 清空所有文件: ${count} 个`);
                    
                    // 清空统计
                    if (window.analytics) {
                        window.analytics.fileAction('clear_all');
                    }
                    
                    this.selectedFiles = [];
                    this.updateDisplay();
                    this.showToast(`🧹 已清空 ${count} 个文件`);
                }
            }
            
            async startCompress() {
                if (this.selectedFiles.length === 0) {
                    this.showToast('⚠️ 请先选择文件');
                    return;
                }
                
                if (this.isCompressing) {
                    this.showToast('⚠️ 正在压缩中，请稍候');
                return;
            }
            
                console.log(`🚀 开始压缩 ${this.selectedFiles.length} 个文件`);
                
                this.isCompressing = true;
                
                // 显示压缩弹框
                const modal = document.getElementById('compressModal');
                modal.style.display = 'flex';
                
                // 压缩开始统计
                if (window.analytics) {
                    window.analytics.compressStart(this.selectedFiles.length, this.getTotalSize());
                }
                
                const startTime = Date.now();
                
                try {
                    // 检查JSZip是否加载
                    if (typeof JSZip === 'undefined') {
                        throw new Error('压缩库未加载，请刷新页面重试');
                    }
                    
                    // 创建JSZip实例
                    const zip = new JSZip();
                    
                    // 添加文件到zip
                    for (let i = 0; i < this.selectedFiles.length; i++) {
                        const file = this.selectedFiles[i];
                        const status = document.getElementById('compressStatus');
                        status.textContent = `正在添加文件: ${file.name} (${i + 1}/${this.selectedFiles.length})`;
                        
                        // 处理文件名冲突
                        let fileName = file.name;
                        let counter = 1;
                        while (zip.file(fileName)) {
                            const nameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
                            const ext = file.name.substring(file.name.lastIndexOf('.'));
                            fileName = `${nameWithoutExt}_${counter}${ext}`;
                            counter++;
                        }
                        
                        zip.file(fileName, file);
                        console.log(`📁 已添加文件: ${fileName} (${this.formatFileSize(file.size)})`);
                        
                        // 小延迟让UI更新
                        await this.sleep(50);
                    }
                    
                    const status = document.getElementById('compressStatus');
                    status.textContent = '正在生成压缩包...';
                    
                    // 生成zip文件
                    const zipBlob = await zip.generateAsync({
                        type: "blob",
                        compression: "DEFLATE",
                        compressionOptions: { level: 6 }
                    }, (metadata) => {
                        // 更新压缩进度
                        const progress = Math.round(metadata.percent);
                        status.textContent = `正在压缩... ${progress}%`;
                    });
                    
                    const duration = Date.now() - startTime;
                    
                    // 保存压缩结果
                    const compressResult = {
                        fileName: `compressed_files_${Date.now()}`,
                        originalSize: this.getTotalSize(),
                        compressedSize: zipBlob.size,
                        fileCount: this.selectedFiles.length,
                        timestamp: Date.now(),
                        duration: duration
                    };
                    
                    console.log('✅ 压缩完成:', compressResult);
                    
                    // 存储结果到全局变量和sessionStorage
                    window.compressedBlob = zipBlob;
                    sessionStorage.setItem('compressResult', JSON.stringify(compressResult));
                    
                    // 创建订单（如果有API）
                    try {
                        await this.createOrder(compressResult);
                    } catch (orderError) {
                        console.error('创建订单失败:', orderError);
                        // 不影响压缩流程
                    }
                    
                    // 压缩成功统计
                    if (window.analytics) {
                        window.analytics.compressComplete(compressResult.originalSize, compressResult.compressedSize, this.selectedFiles.length);
                    }
                    
                    // 隐藏弹框
                    modal.style.display = 'none';
                    this.isCompressing = false;
                    
                     window.location.href = 'result.html';
            } catch (error) {
                    console.error('❌ 压缩失败:', error);
                    
                    // 压缩失败统计
                    if (window.analytics) {
                        window.analytics.compressError(error);
                    }
                    
                    // 隐藏弹框
                    modal.style.display = 'none';
                    this.isCompressing = false;
                    
                    this.showToast('❌ 压缩失败：' + (error.message || '未知错误'));
                }
            }
            
            async createOrder(compressResult) {
                try {
                    const orderData = {
                        file_count: compressResult.fileCount,
                        original_size: compressResult.originalSize,
                        compressed_size: compressResult.compressedSize,
                        compression_ratio: ((compressResult.originalSize - compressResult.compressedSize) / compressResult.originalSize * 100).toFixed(2),
                        timestamp: compressResult.timestamp,
                        user_agent: navigator.userAgent,
                        source: 'h5_compressor_unified'
                    };
                    
                    const response = await fetch('http://p.xiexinbao.com/zww_order/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData),
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const orderId = result.orderId || result.id || Date.now();
                        sessionStorage.setItem('orderId', orderId);
                        console.log('📝 订单创建成功:', orderId);
                        
                        // 订单创建成功统计
                        if (window.analytics) {
                            window.analytics.track('order_created');
                        }
                    } else {
                        console.log('⚠️ 订单创建失败:', response.status);
                    }
                } catch (error) {
                    console.log('⚠️ 订单创建错误:', error.message);
                    // 不影响压缩流程，只记录日志
                }
            }
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // 工具方法
            getTotalSize() {
                return this.selectedFiles.reduce((sum, file) => sum + file.size, 0);
            }
            
            calculateTotalSize(files) {
                return Array.from(files).reduce((sum, file) => sum + file.size, 0);
            }
            
            getFileTypes(files) {
            const types = {};
            files.forEach(file => {
                    const ext = this.getFileExtension(file.name);
                types[ext] = (types[ext] || 0) + 1;
            });
            return types;
        }
        
            getFileExtension(fileName) {
            return fileName.split('.').pop().toLowerCase() || 'unknown';
        }
        
            getFileIcon(fileName) {
                const ext = fileName.split('.').pop().toLowerCase();
                const iconMap = {
                    // 文档类
                    'pdf': '📄',
                    'doc': '📝', 'docx': '📝',
                    'xls': '📊', 'xlsx': '📊', 'csv': '📊',
                    'ppt': '📈', 'pptx': '📈',
                    'txt': '📃', 'rtf': '📃',
                    
                    // 图片类
                    'jpg': '🖼️', 'jpeg': '🖼️', 'png': '🖼️', 'gif': '🖼️',
                    'bmp': '🖼️', 'svg': '🖼️', 'webp': '🖼️', 'ico': '🖼️',
                    
                    // 视频类
                    'mp4': '🎥', 'avi': '🎥', 'mov': '🎥', 'wmv': '🎥',
                    'flv': '🎥', 'mkv': '🎥', 'webm': '🎥',
                    
                    // 音频类
                    'mp3': '🎵', 'wav': '🎵', 'flac': '🎵', 'aac': '🎵',
                    'ogg': '🎵', 'm4a': '🎵',
                    
                    // 压缩类
                    'zip': '📦', 'rar': '📦', '7z': '📦', 'tar': '📦',
                    'gz': '📦', 'bz2': '📦',
                    
                    // 代码类
                    'js': '📜', 'css': '📜', 'html': '📜', 'php': '📜',
                    'py': '📜', 'java': '📜', 'cpp': '📜', 'c': '📜',
                    
                    // 其他
                    'exe': '⚙️', 'dmg': '⚙️', 'app': '⚙️',
                    'json': '📋', 'xml': '📋', 'yml': '📋', 'yaml': '📋'
                };
                
                return iconMap[ext] || '📄';
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
            }
            
            showToast(message, type = 'info') {
            if (window.popToast && typeof window.popToast === 'function') {
                    window.popToast({title: message, timeout: 2000});
            } else {
                    console.log(message); // fallback到控制台输出
                }
            }
        }
        
        // 初始化应用
        const app = new CompressApp();
        window.app = app;
        
        // 全局变量初始化
        var admin_uid = getParamsFromUrl('admin_uid') || localStorage.getItem('admin_uid') || '';
        localStorage.setItem('admin_uid', admin_uid);
        
        // 客服功能
        async function callWxkefu() {
            var user_id = getUserId() || window.fp_id || '';
            var wx_service_link = `https://work.weixin.qq.com/kfid/kfc7d846fca34c6ca69?enc_scene=ENCettynNzrtEHbKDpamvHQPpMev884BwvoYrk3i2CQymZ&scene_param=${user_id}`;
            
            const isWx = /micromessenger/i.test(navigator.userAgent);
            if (isWx) {
                window.location.href = wx_service_link;
                return;
            }
            
            // 非微信环境处理
            const hasTouchScreen = ('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0);
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isMobile = isAndroid || isIOS || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            let deviceType = 'pc';
            if (hasTouchScreen && isMobile) {
                if (isAndroid) {
                    deviceType = 'android';
                } else if (isIOS) {
                    deviceType = 'iphone';
                } else {
                    deviceType = 'android';
                }
            }

            if (deviceType === 'pc') {
                // PC端微信跳转链接处理
                const parsedUrl = new URL(wx_service_link);
                const kfid = parsedUrl.pathname.split('/')[2];
                const encScene = parsedUrl.searchParams.get('enc_scene');
                const sceneParam = parsedUrl.searchParams.get('scene_param');
                const newUrl = new URL('weixin://jumptokfchat/');
                newUrl.searchParams.append('kfid', kfid);
                newUrl.searchParams.append('scene', '50');
                const extParams = new URLSearchParams();
                if (encScene) {
                    extParams.append('enc_scene', encScene);
                }
                if (sceneParam) {
                    extParams.append('scene_param', sceneParam);
                }
                extParams.append('refkey', '');
                newUrl.searchParams.append('ext_params', extParams.toString());
                wx_service_link = newUrl.toString();
            } else {
                // 移动端处理
                try {
                    const getProtocol = () => window.location.protocol.indexOf('https') > -1 ? 'https:' : 'http:';
                    const response = await fetch(getProtocol() + '//www.xiexinbao.com/txb/wxticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: `kfurl=${encodeURIComponent(wx_service_link)}`
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const _kefu_url = await response.text();
                    if (_kefu_url.startsWith('weixin://')) {
                        wx_service_link = _kefu_url;
                    }
                } catch (error) {
                    console.error("获取微信客服链接失败:", error);
                }
            }
            
            window.location.href = wx_service_link;
        }
        
        function getParamsFromUrl(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        
        function getUserId() {
            return localStorage.getItem('user_id') || '';
        }
        
        // 获取协议
        function getProtocol() {
            return window.location.protocol.indexOf('https') > -1 ? 'https:' : 'http:';
        }
        
        // HTTP POST 请求函数
        function http_post(options) {
            const { url, data, callback } = options;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data),
                mode: 'cors'
            })
            .then(response => response.text())
            .then(callback)
            .catch(error => {
                console.error('HTTP请求失败:', error);
                if (callback) callback('{"list":[]}'); // 返回空列表作为fallback
            });
        }
        
        // 数字转62进制
        function to62(num) {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            if (num === 0) return '0';
            while (num > 0) {
                result = chars[num % 62] + result;
                num = Math.floor(num / 62);
            }
            return result;
        }
        
        // 获取我的订单列表
        function getMyOrders() {
            const orderListSection = document.getElementById('orderListSection');
            const orderList = document.getElementById('orderList');
            
            http_post({
                url: getProtocol() + '//p.xiexinbao.com/zww_order/mylist',
                data: {
                    user_id: getUserId() || window.fp_id || '',
                    openid: '',
                    limit: 50
                },
                callback: function(html) {
                    try {
                        const result = JSON.parse(html);
                        let tpls = result.list || [];

                        // 过滤出 data_out_temp 以 'http' 开头的订单
                        tpls = tpls.filter(function(item) {
                            return item.data_out_temp && item.data_out_temp.startsWith('http');
                        });

                        // 按创建时间倒序排序
                        tpls.sort(function(a, b) {
                            return parseInt(b.ctime) - parseInt(a.ctime);
                        });

                        if (tpls.length > 0) {
                            // 显示订单列表区域
                            orderListSection.style.display = 'block';
                            
                            let orderListHtml = '<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;"><h3 style="font-size: 18px; color: #333; margin: 0;">历史记录</h3><span style="font-size: 12px; color: #888;">仅保留24小时, 请提前下载备份</span></div>';
                            orderListHtml += '<div class="order-items">';
                            
                            tpls.forEach(function(item) {
                                // 从订单数据中获取压缩包信息
                                let fileName = '压缩包.zip';
                                let fileCount = 0;
                                
                                try {
                                    const dataIn = JSON.parse(item.data_in || '{}');
                                    if (dataIn.file_count) {
                                        fileCount = dataIn.file_count;
                                        fileName = `压缩包(${fileCount}个文件).zip`;
                                    }
                                } catch (e) {
                                    console.error('解析订单数据失败:', e);
                                }
                                
                                const payCallback = `result.html?order_id=${item.id}`;
                                
                                orderListHtml += '<div class="order-item" style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                                orderListHtml += '<div class="item-icon" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #3B82F6; color: white; font-weight: bold; font-size: 12px;">';
                                orderListHtml += 'ZIP';
                                orderListHtml += '</div>';
                                orderListHtml += '<div class="file-info" style="flex: 1; overflow: hidden;">';
                                orderListHtml += '<div class="file-name" style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + fileName + '</div>';
                                if (fileCount > 0) {
                                    orderListHtml += '<div class="file-count" style="font-size: 12px; color: #666; margin-top: 2px;">包含 ' + fileCount + ' 个文件</div>';
                                }
                                orderListHtml += '</div>';
                                orderListHtml += '<a href="' + payCallback + '" class="download-btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block;">下载</a>';
                                orderListHtml += '</div>';
                            });
                            
                            orderListHtml += '</div>';
                            orderList.innerHTML = orderListHtml;
                            
                            console.log(`📋 加载了 ${tpls.length} 个历史订单`);
                        } else {
                            // 没有订单时隐藏区域
                            orderListSection.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('解析订单列表失败:', error);
                        orderListSection.style.display = 'none';
                    }
                }
            });
        }
        
        console.log('🚀 文件压缩工具已加载完成');
    </script>

    <!-- 统计脚本 -->
    <script>
        (function() {
            var cswtj_id = '';
            var _plat = window.location.hostname;
            var _w = 'index.html';
            if (typeof localStorage == "object") {
                cswtj_id = localStorage.getItem('cswtj_id') || ''; 
            }
            function _loadtj(retries) {
                var hm = document.createElement("script");
                hm.src = getProtocol()+"//log.xiexinbao.com/cswtj.js?plat="+_plat+"&w="+_w+"&cswtj_id="+cswtj_id;
                hm.onload = function() {};
                hm.onerror = function() {
                    if (retries > 0) {
                        _loadtj(retries - 1);
                    }
                    console.log('cswtj.js load error!')
                };
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            }
            _loadtj(1);
        })();
    </script>
</body>
</html>