

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶å‹ç¼©å·¥å…·</title>
    
    <!-- å¿…è¦çš„ç¬¬ä¸‰æ–¹åº“ - ä» index.html å¤åˆ¶ -->
    <script src="https://zww2.xiexinbao.com/js/page-components-0830.js"></script>

    <!-- åŸæœ‰çš„å‹ç¼©ç›¸å…³åº“ -->
    <script src="https://zww2.xiexinbao.com/js/zww_utils.js"></script>
    <script src="https://zww2.xiexinbao.com/js/custom-toast.js"></script>
    <script src="https://zww2.xiexinbao.com/js/zww_uploader.js"></script>
    <!-- ä½¿ç”¨ zip.js æ›¿ä»£ JSZip (å®Œæ•´ç‰ˆï¼ŒåŒ…å«å†…ç½® Worker) -->
    <script src="https://unpkg.com/@zip.js/zip.js@2/dist/zip-full.min.js"></script>

    <style>
        /* å®Œå…¨å¤åˆ¶ index.html çš„æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f6f7fb 0%, #f0f4f9 100%);
            color: #1b1b1b;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
        }

        a {
            text-decoration: none; 
            color: inherit; 
        }

        /* ä¸»å®¹å™¨æ ·å¼ */
        #main-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 8px;
            width: 100%;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>
    <div id="main-container">
        <!-- æ‰€æœ‰ç»„ä»¶å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
    </div>

    <script src="https://caipiao88.oss-cn-hangzhou.aliyuncs.com/cdn/fp/thumbmark.umd.js"></script>
    <script>
        ThumbmarkJS.getFingerprint().then(
            function (fp) {
                window.fp_id = fp;
            }
        );
    </script>

<script>
    // å…¼å®¹æ€§æ£€æŸ¥å’Œåˆå§‹åŒ–
    if (typeof $ShowCast === 'undefined') {
        window.$ShowCast = {
            loading: (msg) => console.log('Loading:', msg),
            success: (msg) => console.log('Success:', msg),
            error: (msg) => console.log('Error:', msg),
            closeAll: () => console.log('Close all')
        };
    }

    var popDiv;

    // å…¨å±€å˜é‡
    const order_id = getId();
    const item_id = '4';
    const item_name = 'zipå‹ç¼©';
    const task_type = 'zip';

    // Result URL
    var result_url = '';
    if (window.location.host.indexOf("127.0.0.1") >= 0) {
        result_url = getProtocol()+"//"+window.location.host+`/zww/zip_result.html?id=`+order_id;
    } else {
        result_url = getProtocol()+"//"+window.location.host+`/zww/zip_result.html?id=`+order_id;
    }

    // é¡µé¢ç»„ä»¶
    let pageComponents = {};

    // å¾®ä¿¡å®¢æœåŠŸèƒ½ - ä½¿ç”¨åŸæ¥ zip_index.html çš„é€»è¾‘
    window.callWxkefu = async () => {
        var user_id = getUserId() || window.fp_id || '';
        // https://work.weixin.qq.com/kfid/kfc3cef22a5282e26e8?enc_scene=ENCCBodKkRSro2NyHPoCbkVbTZx9c7WbVhpRub6NUjcMwyP
        var wx_service_link = `https://work.weixin.qq.com/kfid/kfc3cef22a5282e26e8?enc_scene=ENCCBodKkRSro2NyHPoCbkVbTZx9c7WbVhpRub6NUjcMwyP&scene_param=${user_id}`;
        
        const isWx = /micromessenger/i.test(navigator.userAgent);
        if (isWx) {
            window.location.href = wx_service_link;
            return;
        }

        const hasTouchScreen = ('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isMobile = isAndroid || isIOS || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        let deviceType = 'pc';
        if (hasTouchScreen && isMobile) {
            if (isAndroid) {
                deviceType = 'android';
            } else if (isIOS) {
                deviceType = 'iphone';
            } else {
                deviceType = 'android';
            }
        }

        if (deviceType === 'pc') {
            const parsedUrl = new URL(wx_service_link);
            const kfid = parsedUrl.pathname.split('/')[2];
            const encScene = parsedUrl.searchParams.get('enc_scene');
            const sceneParam = parsedUrl.searchParams.get('scene_param');
            const newUrl = new URL('weixin://jumptokfchat/');
            newUrl.searchParams.append('kfid', kfid);
            newUrl.searchParams.append('scene', '50');
            const extParams = new URLSearchParams();
            if (encScene) {
                extParams.append('enc_scene', encScene);
            }
            if (sceneParam) {
                extParams.append('scene_param', sceneParam);
            }
            extParams.append('refkey', '');
            newUrl.searchParams.append('ext_params', extParams.toString());
            wx_service_link = newUrl.toString();
        } else {
            try {
                const response = await fetch(getProtocol() + '//www.xiexinbao.com/txb/wxticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `kfurl=${encodeURIComponent(wx_service_link)}`
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const _kefu_url = await response.text();
                if (_kefu_url.startsWith('weixin://')) {
                    wx_service_link = _kefu_url;
                }
            } catch (error) {
                console.error("è·å–å¾®ä¿¡å®¢æœé“¾æ¥å¤±è´¥:", error);
            }
        }

        window.location.href = wx_service_link;
    };

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        console.log('åˆå§‹åŒ–æ–‡ä»¶å‹ç¼©å·¥å…·é¡µé¢');

        // 1. åˆå§‹åŒ–å¤´éƒ¨ç»„ä»¶
        pageComponents.header = PageComponents.Header.init({
            container: 'body',
            title: 'æ–‡ä»¶å‹ç¼©å·¥å…·',
            navLinks: [
                {text: 'é¦–é¡µ', href: '/'}
            ]
        });

        // 2. ä¿®æ”¹æ–‡ä»¶é€‰æ‹©å™¨é…ç½®ï¼Œç®€åŒ–é…ç½®é¿å…å†²çª
        pageComponents.fileSelector = PageComponents.FileSelector.init({
            container: '#main-container',
            title: 'é€‰æ‹©æ–‡ä»¶å¼€å§‹å‹ç¼©',
            subtitle: 'æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼åŒæ—¶ä¸Šä¼ å¹¶å‹ç¼©',
            buttonText: 'é€‰æ‹©æ–‡ä»¶',
            acceptTypes: ['*/*'],
            multiple: false,
            maxFiles: 100,
            displayMode: 'list',
            showPreview: false, // æ”¹ä¸º trueï¼Œè®©åº“å¤„ç†é¢„è§ˆé€»è¾‘
            allowSorting: false,
            allowDelete: true,
            allowRename: true,
            listMode: {
                style: 'enhanced',
                showCounter: false,
                allowRotate: false,
                previewBackground: 'pattern',
                customActions: []
            },
            // ç®€åŒ–å›è°ƒï¼Œè®©åº“è‡ªå·±å¤„ç†å¤§éƒ¨åˆ†é€»è¾‘
            onFileSelect: handleFileSelect,
            onFileRemove: (fileId, remainingFiles) => {
                console.log('æ–‡ä»¶åˆ é™¤å›è°ƒ:', fileId, remainingFiles);
                if (remainingFiles.length === 0) {
                    resetToInitialState();
                }
            },
            onFilePreview: (fileData, index) => {
                // å¯¹äºéå›¾ç‰‡æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                console.log('æ–‡ä»¶é¢„è§ˆ:', fileData.file?.name);
                if (fileData.file) {
                    $ShowCast.success(`æ–‡ä»¶ä¿¡æ¯ï¼š${fileData.file.name} (${formatFileSize(fileData.file.size)})`);
                }
                return false; // é˜»æ­¢é»˜è®¤é¢„è§ˆè¡Œä¸º
            },
            onReset: resetToInitialState
        });

        // 3. åˆå§‹åŒ–æç¤ºç»„ä»¶
        pageComponents.tips = PageComponents.Tips.init({
            container: '#main-container',
            tips: [
                {
                    text: 'é‡åˆ°é—®é¢˜ï¼š',
                    linkText: 'ç‚¹æ­¤è”ç³»å®¢æœ',
                    action: 'service'
                }
            ],
            onServiceClick: callWxkefu
        });

        // 4. åˆå§‹åŒ–æœ€æ–°è®¢å•ç»„ä»¶ï¼ˆæ˜¾ç¤ºå†å²å‹ç¼©è®°å½•ï¼‰
        pageComponents.recentOrders = PageComponents.RecentOrders.init({
            container: '#main-container',
            item_id: item_id,
            limit: 30,
            timeRange: 1,
            title: 'å†å²è®°å½•',
            buttonText: 'ä¸‹è½½',
            onlypaid: false,
            user_id: getUserId(),
        });

        // 5. åˆå§‹åŒ–å¯¼å‡ºå®¹å™¨
        pageComponents.exportContainer = PageComponents.ExportContainer.init({
            container: 'body',
            buttons: [
                { text: 'ç»§ç»­æ·»åŠ ', action: 'add', icon: 'plus' },
                { text: 'å¼€å§‹å‹ç¼©', action: 'export', icon: 'download' }
            ],
            onButtonClick: handleExportAction
        });

        // è®¾ç½®åˆå§‹çŠ¶æ€
        pageComponents.exportContainer.hide();

        // å…¨å±€è®¿é—®
        window.pageComponents = pageComponents;
    });

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    async function handleFileSelect(files) {
        console.log('é€‰æ‹©æ–‡ä»¶:', files);
        
        if (files.length > 0) {
            $ShowCast.loading('æ­£åœ¨åŠ è½½...');
            
            // æœ‰æ–‡ä»¶ï¼šå…ˆéšè—æç¤ºå’Œè®¢å•ç»„ä»¶
            pageComponents.tips.hide();
            pageComponents.recentOrders.hide();
            
            try {
                pageComponents.fileSelector.showFiles();
                
                // å¤„ç†å®Œæˆï¼šæ˜¾ç¤ºå¯¼å‡ºå®¹å™¨
                pageComponents.exportContainer.show();
                
            } catch (error) {
                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                $ShowCast.error('æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                // å¤±è´¥ï¼šæ˜¾ç¤ºæç¤ºå’Œè®¢å•ç»„ä»¶
                pageComponents.tips.show();
                pageComponents.recentOrders.show();
            } finally {
                $ShowCast.closeAll();
            }
        }
    }


    // å¤„ç†æ–‡ä»¶åˆ é™¤
    function handleFileRemove(fileId, remainingFiles) {
        console.log('åˆ é™¤æ–‡ä»¶:', fileId, 'å‰©ä½™æ–‡ä»¶:', remainingFiles.length);
        
        // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œé‡ç½®çŠ¶æ€
        if (remainingFiles.length === 0) {
            resetToInitialState();
        }
    }

    // å¤„ç†å¯¼å‡ºæ“ä½œ
    function handleExportAction(action) {
        if (action === 'add') {
            // ç»§ç»­æ·»åŠ æ–‡ä»¶
            addMoreFiles();
        } else if (action === 'export') {
            // å¼€å§‹å‹ç¼©
            startCompress();
        }
    }

    // ç»§ç»­æ·»åŠ æ–‡ä»¶
    function addMoreFiles() {
        console.log("[ç»§ç»­æ·»åŠ ] ç‚¹å‡»ç»§ç»­æ·»åŠ æ–‡ä»¶æŒ‰é’®");
        
        // ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶çš„æ–¹æ³•æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©
        if (pageComponents.fileSelector) {
            pageComponents.fileSelector.triggerFileSelect();
        } else {
            console.error('[ç»§ç»­æ·»åŠ ] æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶æœªæ‰¾åˆ°');
            $ShowCast.error('æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    }

    // é‡ç½®åˆ°åˆå§‹çŠ¶æ€
    function resetToInitialState() {
        console.log('é‡ç½®åˆ°åˆå§‹çŠ¶æ€');
        
        // é‡ç½®ç»„ä»¶çŠ¶æ€
        if (pageComponents.exportContainer) {
            pageComponents.exportContainer.hide();
        }
        
        // ä¸è¦éšè—æ–‡ä»¶é€‰æ‹©å™¨ï¼Œè€Œæ˜¯ç¡®ä¿å®ƒæ˜¾ç¤º
        if (pageComponents.fileSelector) {
            // å¦‚æœæœ‰æ–‡ä»¶ï¼Œä¿æŒæ˜¾ç¤ºï¼›å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œä¹Ÿè¦æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
            pageComponents.fileSelector.show();
        }
        
        // å»¶è¿Ÿæ˜¾ç¤ºæç¤ºå’Œè®¢å•ç»„ä»¶
        setTimeout(() => {
            if (pageComponents.tips) {
                pageComponents.tips.show();
            }
            if (pageComponents.recentOrders) {
                pageComponents.recentOrders.show();
            }
        }, 100);
    }

    // ä¿®æ”¹åçš„æ–‡ä»¶é€‰æ‹©å¤„ç†å‡½æ•°
    function handleFileSelectAfter(files) {
        console.log('å»¶è¿Ÿå¤„ç†æ–‡ä»¶é€‰æ‹©:', files);
        
        if (files && files.length > 0) {
            // éšè—æç¤ºå’Œè®¢å•ç»„ä»¶
            if (pageComponents.tips) {
                pageComponents.tips.hide();
            }
            if (pageComponents.recentOrders) {
                pageComponents.recentOrders.hide();
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºå®¹å™¨
            if (pageComponents.exportContainer) {
                pageComponents.exportContainer.show();
            }
        }
    }

    // ===== æ–‡ä»¶å¤„ç†ç›¸å…³å‡½æ•° =====

    // ä¸ºç»„ä»¶å¤„ç†æ–‡ä»¶
    async function processFilesForComponent(files) {
        console.log(`å¼€å§‹ä¸ºç»„ä»¶å¤„ç† ${files.length} ä¸ªæ–‡ä»¶`);
        // ç®€åŒ–å¤„ç†ï¼ŒåªåšåŸºæœ¬éªŒè¯ï¼Œä¸å¹²æ‰°åº“çš„æ–‡ä»¶å¯¹è±¡
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            console.log(`æ–‡ä»¶å¤„ç†: ${file.name} (${formatFileSize(file.size)})`);
        }
        console.log('æ–‡ä»¶å¤„ç†å®Œæˆ');
    }

    // é¢„å¤„ç†æ–‡ä»¶åï¼Œé¿å…é‡å¤
    function preprocessFileNames(selectedFiles) {
        const nameMap = new Map();
        const processedFiles = [];
        
        for (const fileData of selectedFiles) {
            const file = fileData.file;
            let fileName = file.name;
            
            // å¤„ç†é‡å
            if (nameMap.has(fileName)) {
                let counter = nameMap.get(fileName) + 1;
                nameMap.set(fileName, counter);
                
                const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                const ext = fileName.substring(fileName.lastIndexOf('.'));
                fileName = `${nameWithoutExt}_${counter}${ext}`;
            } else {
                nameMap.set(fileName, 1);
            }
            
            processedFiles.push({
                file: file,
                processedName: fileName
            });
        }
        
        return processedFiles;
    }

    // å¼€å§‹å‹ç¼© - ä½¿ç”¨ zip.js æ›¿ä»£ JSZip
    async function startCompress() {
        const selectedFiles = pageComponents.fileSelector.files;
        console.log('è·å–åˆ°çš„æ–‡ä»¶åˆ—è¡¨:', selectedFiles);
        console.log('æ–‡ä»¶æ•°é‡:', selectedFiles.length);
        
        if (selectedFiles.length === 0) {
            $ShowCast.error('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼');
            return;
        }

        $ShowCast.loading('è¯·ç¨å€™...');
        let progressToast = createCustomProgressToast(0);

        try {
            console.log('ğŸ—ƒï¸ å¼€å§‹å‹ç¼©:', selectedFiles.length, 'ä¸ªæ–‡ä»¶');

            // æ£€æŸ¥ zip.js æ˜¯å¦åŠ è½½
            if (typeof zip === 'undefined') {
                throw new Error('å‹ç¼©åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }

            // é…ç½® zip.js (å¯é€‰ï¼Œä¼˜åŒ–æ€§èƒ½)
            zip.configure({
                useWebWorkers: true,      // å¯ç”¨ Worker
                maxWorkers: 2,            // é™åˆ¶ Worker æ•°é‡
                terminateWorkerTimeout: 5000  // Worker ç©ºé—² 5 ç§’åç»ˆæ­¢
            });

            // åˆ›å»º BlobWriter å’Œ ZipWriter
            const blobWriter = new zip.BlobWriter("application/zip");
            const zipWriter = new zip.ZipWriter(blobWriter);
            
            // é¢„å¤„ç†æ–‡ä»¶åï¼Œé¿å…é‡å¤
            const processedFiles = preprocessFileNames(selectedFiles);
            
            // æ·»åŠ æ–‡ä»¶åˆ° zip
            let currentFileIndex = 0;
            const totalFiles = processedFiles.length;
            
            for (const fileData of processedFiles) {
                const file = fileData.file;
                const fileName = fileData.processedName || file.name;
                
                // æ·»åŠ å•ä¸ªæ–‡ä»¶ï¼Œå¸¦è¿›åº¦å›è°ƒ
                await zipWriter.add(
                    fileName, 
                    new zip.BlobReader(file),
                    {
                        level: 6,  // å‹ç¼©çº§åˆ« (0-9)
                        useWebWorkers: true,  // ä½¿ç”¨ Worker
                        onprogress: (progress, total) => {
                            // è®¡ç®—æ€»è¿›åº¦
                            const fileProgress = (currentFileIndex / totalFiles) * 100;
                            const currentFileProgress = (progress / total) * (100 / totalFiles);
                            const totalProgress = Math.round(fileProgress + currentFileProgress);
                            
                            if (progressToast && typeof progressToast.updateProgress === 'function') {
                                try {
                                    progressToast.updateProgress(totalProgress);
                                } catch (e) {
                                    console.error('æ›´æ–°è¿›åº¦æ¡å¤±è´¥', e);
                                }
                            }
                            
                            // è°ƒè¯•è¾“å‡º
                            if (totalProgress % 10 === 0 || totalProgress === 100) {
                                console.log(`è¿›åº¦æ›´æ–°: ${totalProgress}%`);
                            }
                        }
                    }
                );
                
                console.log(`ğŸ“ å·²æ·»åŠ æ–‡ä»¶: ${fileName} (${formatFileSize(file.size)})`);
                currentFileIndex++;
                
                // å°å»¶è¿Ÿè®©UIæ›´æ–°
                await sleep(10);
            }
            
            // å…³é—­ ZipWriter
            await zipWriter.close();
            
            // è·å–å‹ç¼©åçš„ blob
            const zipBlob = await blobWriter.getData();
            
            console.log(`âœ… å‹ç¼©å®Œæˆï¼Œæ–‡ä»¶å¤§å°: ${formatFileSize(zipBlob.size)}`);
            
            // å…³é—­è¿›åº¦æ˜¾ç¤º
            if (progressToast && typeof progressToast.close === 'function') {
                progressToast.close();
            }
            
            // ä¸Šä¼ æ–‡ä»¶
            popDiv = popToast({title:'æ–‡ä»¶ä¸Šä¼ ä¸­...',icon:'loading'});
    
            var file_url = await upload_file({
                buffer: await zipBlob.arrayBuffer(),
                length: zipBlob.size
            });
            var file_size = zipBlob.size;

            // åˆ›å»ºè®¢å•
            await createCompressOrder(selectedFiles, file_url, file_size);

            popDiv.closeSelf();

            $ShowCast.closeAll();
            window.location.href = result_url;
            
        } catch (error) {
            console.error('å‹ç¼©å¤±è´¥:', error);
            $ShowCast.error('å‹ç¼©å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            
            // å…³é—­è¿›åº¦æ˜¾ç¤º
            if (progressToast && typeof progressToast.close === 'function') {
                progressToast.close();
            }
        } finally {
            $ShowCast.closeAll();
        }
    }


    // åˆ›å»ºå‹ç¼©è®¢å• - åŸºäºåŸæ¥çš„é€»è¾‘
    async function createCompressOrder(selectedFiles, file_url, file_size) {
        try {
            var user_id = getUserId() || window.fp_id || '';
            var order_result_page = `/zww/zip_result.html?id=${order_id}`;
            var pay_callback = order_result_page;
            var fileSize = (file_size/1024/1024).toFixed(1);
            var ori_file_size = getTotalSize(selectedFiles);
            var ori_file_size_mb = (ori_file_size/1024/1024).toFixed(1);
            
            var data_in = {
                'jump_kefu': 0,
                'admin_uid': admin_uid,
                'do_id': 4,
                'item_id': 4,
                'item_name': 'zipå‹ç¼©',
                'task_type': 'zip',
                'file_size': fileSize,
                'ori_file_size': ori_file_size_mb,
                'ori_file_url': '',
                'ori_file_name': `${(order_id || Date.now())+'_'+selectedFiles.length}.zip`,
            };
                
            const order_req_params = {
                'id': order_id,
                'item_id': 4,
                'item_name': 'zipå‹ç¼©',
                'item_img': 'https://zww2.xiexinbao.com/icons/zip.png',
                'user_id': user_id,
                'fp_id': window.fp_id||'',
                'ua': getOS()+'_' +getBrowser(),
                'price': 4.9,
                'generate_status': 0,
                'tag': 'zip',
                "data_in": data_in,
                'data_out': '',
                'data_out_temp': file_url,
                'generate_status': parseInt(Date.now()/ 1000),
                'result_msg': navigator?.userAgent?.toLowerCase(),
                'track': window.location.host,
                'pay_callback': pay_callback,
                'overtime': 0
            };

            var order_status = await http_create_order(order_req_params);
            console.log('order_status', order_status);

            var ori_file_name = data_in.ori_file_name;
            await add_wxfile({
                id: order_id, 
                ua: getOS()+'_' +getBrowser(),
                file_url: file_url, 
                file_size: file_size, 
                file_type: 'zip', 
                file_name: ori_file_name, 
                "uid":"zww", 
                "media_id_otime":0,
                "media_id":""
            });
            
        } catch (error) {
            console.log('âš ï¸ è®¢å•åˆ›å»ºé”™è¯¯:', error.message);
            throw error;
        }
    }

    // å·¥å…·å‡½æ•°
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function getTotalSize(selectedFiles) {
        return selectedFiles.reduce((sum, fileData) => sum + fileData.file.size, 0);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
    }

    // å…¨å±€å˜é‡åˆå§‹åŒ–
    var admin_uid = getParamsFromUrl('admin_uid') || localStorage.getItem('admin_uid') || '';
    localStorage.setItem('admin_uid', admin_uid);

</script>

<!-- åŸæœ‰çš„å·¥å…·å‡½æ•° -->
<script>
    function http_create_order(reqParams){
      return new Promise((resolve, reject) => {
          http_post({url:getProtocol()+'//p.xiexinbao.com/zww_order/add',data:reqParams,callback:function(result){
              resultObject = JSON.parse(result); 
              resolve(resultObject.status);
          }})
      });
    };

    function add_wxfile(reqParams){
        return new Promise((resolve, reject) => {
            http_post({url:getProtocol()+'//p.xiexinbao.com/csj_wxkefu_file/add_or_set',data:reqParams,callback:function(result){
                resolve();
            }})
        });
    };

    async function upload_file(zip_data) {
        var file_obj = {
            data: zip_data.buffer,
            size: zip_data.length,
            mime: "application/octet-stream",
            suffix: ".zip",
            name: zip_data.name || "output.zip",
        }
        var file_url = await $uploader.uploadFile(Object.assign(file_obj, {filename:`/zww/ori_file/zip/${order_id}/${Date.now()}${file_obj.suffix}`}));
        if(file_url && file_url.indexOf('http')>-1) {
            return new Promise(function(resolve,reject){
                resolve(file_url);
            });
        } else {
            file_obj.retry = true;
            return await upload_file_bak(file_obj);
        };
    }
</script>

<!-- ç»Ÿè®¡è„šæœ¬ -->
<script>
    (function () {
        var cswtj_id = '';
        var _plat = window.location.hostname;
        var _w = 'zip_index.html';
        if (typeof localStorage == "object") {
            cswtj_id = localStorage.getItem('cswtj_id') || '';
        }
        function _loadtj(retries) {
            var hm = document.createElement("script");
            hm.src = getProtocol() + "//log.xiexinbao.com/cswtj.js?plat=" + _plat + "&w=" + _w + "&cswtj_id=" + cswtj_id;
            hm.onload = function () { };
            hm.onerror = function () {
                if (retries > 0) {
                    _loadtj(retries - 1);
                }
                console.log('cswtj.js load error!')
            };
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        }
        _loadtj(1);
    })();
</script>
</body>
</html>