<html lang="zh-CN" style="font-size: 44.8px;">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
	<title>...</title>
	<meta name="description" content="">
    <script src="https://caipiao88.oss-accelerate.aliyuncs.com/cdn/js/pop3.js?t=2222"></script>
    
    <style>
		* {padding: 0;margin: 0;box-sizing: border-box;}
		*::-webkit-scrollbar{display:none;width:0px;height:0px;}*::-webkit-scrollbar-corner {display:none;width:0px;height:0px; }*::-webkit-resizer{display:none;}
		
		.weui-icon-success-no-circle {
			display:inline-block;
			margin-bottom: 5px;
			-webkit-mask-repeat: no-repeat;
			mask-repeat: no-repeat;
			-webkit-mask-size: 100%;
			mask-size: 100%;
			background-color: currentColor;
			color: #07c160;
			width: 50px;
			height: 50px;
			mask-image: url(data:image/svg+xml,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M8.657%2018.435L3%2012.778l1.414-1.414%204.95%204.95L20.678%205l1.414%201.414-12.02%2012.021a1%201%200%2001-1.415%200z%22%20fill-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E);
			-webkit-mask-image: url(data:image/svg+xml,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M8.657%2018.435L3%2012.778l1.414-1.414%204.95%204.95L20.678%205l1.414%201.414-12.02%2012.021a1%201%200%2001-1.415%200z%22%20fill-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E);
		}
		.modal-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			align-items: center;
			justify-content: center;
		}

		.modal-overlay.show {
			display: flex;
		}

		.payment-modal-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			align-items: center;
			justify-content: center;
		}

		.payment-modal-overlay.show {
			display: flex;
		}
	</style>
    <script>
		/**
		 * è®¾ç½®Cookie
		 * @param {string} name - Cookieåç§°
		 * @param {string} value - Cookieå€¼
		 * @param {number} days - è¿‡æœŸå¤©æ•°ï¼Œé»˜è®¤30å¤©
		 */
		function setCookie(name, value, days = 30) {
			const expires = new Date();
			expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
			document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
		}
		/**
		 * æ›´æ–°ç”¨æˆ·IDåˆ°å„ç§å­˜å‚¨ä¸­
		 * @param {string} userId - ç”¨æˆ·ID
		 */
		function updateUserId(userId) {
			// æ›´æ–°åˆ°Cookieä¸­
			setCookie('openid', userId);
			setCookie('cswtj_id', userId);
			
			// æ›´æ–°åˆ°localStorageä¸­
			try {
				localStorage.setItem('openid', userId);
				localStorage.setItem('cswtj_id', userId);
			} catch (e) {
				console.warn('localStorageä¸å¯ç”¨:', e);
			}
			
			console.log('ç”¨æˆ·IDå·²æ›´æ–°åˆ°Cookieå’ŒlocalStorage:', userId);
		}

		function getProtocol(){
			return window.location.protocol.indexOf('https')>-1?'https:':'http:';
		}
		String.prototype.replaceAll = function(s1,s2){ 
			return this.replace(new RegExp(s1, "gm"), s2);
		}
		function extractHttpLink(text) {
			// æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…httpå’Œhttpsé“¾æ¥
			const httpUrlRegex = /(\bhttps?:\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
			// ä½¿ç”¨matchæ–¹æ³•æå–æ‰€æœ‰åŒ¹é…é¡¹
			const found = text.match(httpUrlRegex);
			return found?found[0]:text;
		};
		function http_get(req){var xhr=new XMLHttpRequest();xhr.ontimeout=function(e){xhr.abort()};xhr.onerror=function(e){};xhr.open("GET",req.url,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){req.callback(xhr.responseText)}};xhr.timeout=10*1000;xhr.send()}
		function http_post(req){var xhr=new XMLHttpRequest();xhr.ontimeout=function(e){xhr.abort()};xhr.onerror=function(e){};xhr.open("POST",req.url,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){req.callback(xhr.responseText)}};xhr.timeout=10*1000;xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");var post_data=[];var postData=req.data;postData=(function(value){for(var key in value){if(typeof(value[key])=='object'){post_data.push(key+"="+encodeURIComponent(JSON.stringify(value[key])))}else{post_data.push(key+"="+encodeURIComponent(value[key]))}};return post_data.join('&')}(postData));xhr.send(postData)}
		function getParamsFromUrl(a){try {var query = window.location.search.substring(1);var vars = query.split("&");for(var i=0;i<vars.length;i++) {var pair = vars[i].split("=");if(pair[0] == a){return pair[1];}}}catch(e){}return(false);};
	</script>
</head>
<body>

    <div class="content-detail">
        <div class="content-bd">
            <img style="pointer-events: none;user-select: none; max-height: 100%; object-fit: contain;" src="https://down.xiexinbao.com/cdn/icon/zip.png" />
            <span class="content-name"></span>
            <span class="content-size"></span>
        </div>

        <div class="content-ft">
            <div class="download-btn" onclick="download_file()">ä¸‹è½½æ–‡ä»¶</div>
        </div>
        <style>
            .content-detail{
                background:#f6f7fb;
                display:flex;
                flex-direction: column;
                height:100%;
                width:100%;
                
            }
            .content-bd {
                width: 100%;
                flex: 1;
                background:#f6f7fb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                padding: 6px;
            }
            .content-bd  .img-info{
                display:inline-block;
                display:flex;
                flex-direction: column;
                align-items: center;
            }
            .content-bd .content-name {
                margin-top: 20px;
                margin-bottom: 5px;
                font-size: 14px;
            }
            .content-bd .content-size {
                margin-bottom: 20px;
                font-size: 14px;
            }
            .content-ft{
                width:100%;
                background:#fff;
                border-top-left-radius: 14px;
                border-top-right-radius: 14px;
                height:78px;
                overflow:hidden;
            }
            .content-ft .download-btn,.download-btn{
                width: 96%;
                height: 1.3rem;
                display: -ms-flexbox;
                display: flex;
                -ms-flex-align: center;
                align-items: center;
                -ms-flex-pack: center;
                justify-content: center;
                border-radius: 0.66666667rem;
                font-size: 0.42666667rem;
                background-color: #7F6AFF;
                color: #FFFFFF;
                font-family: PingFangSC-Medium, PingFang SC;
                font-weight: 500;
                text-align: center;
                margin: 10px auto 10px ;
                cursor:pointer;
            }


        </style>
    </div>

    <!-- Phone Binding Modal -->
    <div id="phoneBindModal" class="modal-overlay">
        <div class="payment-dialog" style="max-width: 320px;">
            <button class="close-btn" onclick="document.getElementById('phoneBindModal').style.display = 'none';">Ã—</button>
            <h3 style="color: white; text-align: center; margin-bottom: 15px;font-size:18px;">ç»‘å®šæ‰‹æœºå·</h3>
            <p style="color: #ccc; font-size: 14px; margin-bottom: 15px;">ç»‘å®šæ‰‹æœºå·ï¼Œæ–¹ä¾¿æ‰¾å›è´¦æˆ·ä¿¡æ¯å’Œè·å–é€šçŸ¥ã€‚</p>
            <input type="tel" id="phoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #555; background-color: #333; color: white; margin-bottom: 15px;">
            <button id="submitPhoneBind" class="pay-btn wechat-btn" style="background-color: #7F6AFF;">ç«‹å³ç»‘å®š</button>
            <div id="phoneBindMsg" style="color: #ff4d4f; text-align: center; margin-top: 10px; font-size: 13px;"></div>
        </div>
    </div>
    <style>
        #phoneBindModal .payment-dialog { /* Reusing some styles */
            padding: 25px;
        }
    </style>

    <!-- Member Recovery Modal -->
    <div id="memberRecoveryModal" class="modal-overlay">
        <div class="payment-dialog" style="max-width: 320px;">
            <button class="close-btn" onclick="document.getElementById('memberRecoveryModal').style.display = 'none';">Ã—</button>
            <h3 style="color: white; text-align: center; margin-bottom: 20px; font-size: 18px;">ä¼šå‘˜éªŒè¯</h3>
            
            <!-- æ‰‹æœºå·éªŒè¯åŒºåŸŸ -->
            <div id="phoneVerifyArea" class="verify-area">
                <p style="color: #ccc; font-size: 14px; margin-bottom: 15px;">è¾“å…¥ç»‘å®šçš„æ‰‹æœºå·ï¼ŒéªŒè¯æ‚¨çš„ä¼šå‘˜èº«ä»½</p>
                <input type="tel" id="recoveryPhoneInput" placeholder="è¯·è¾“å…¥ç»‘å®šçš„æ‰‹æœºå·" style="width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #555; background-color: #333; color: white; margin-bottom: 15px; font-size: 16px;">
                <button id="submitPhoneVerify" class="pay-btn wechat-btn" style="background-color: #7F6AFF;">éªŒè¯ä¼šå‘˜</button>
            </div>
            
            <div id="memberRecoveryMsg" style="color: #ff4d4f; text-align: center; margin-top: 10px; font-size: 13px;"></div>
        </div>
    </div>



    <!-- Member Expired Modal -->
    <div id="memberExpiredModal" class="modal-overlay">
        <div class="payment-dialog" style="max-width: 320px;">
            <button class="close-btn" onclick="document.getElementById('memberExpiredModal').style.display = 'none';">Ã—</button>
            

            
            <h3 style="color: white; text-align: center; margin-bottom: 15px; font-size: 18px;">ä¼šå‘˜å·²åˆ°æœŸ</h3>
            <p style="color: #ccc; font-size: 14px; text-align: center; margin-bottom: 25px;">æ‚¨çš„ä¼šå‘˜å·²äº2025å¹´6æœˆ1æ—¥åˆ°æœŸï¼Œè¯·ç»­è´¹åç»§ç»­ä½¿ç”¨ã€‚</p>
            
            <button id="renewMemberBtn" class="pay-btn" style="background-color: #7F6AFF; margin-bottom: 12px;">ç«‹å³ç»­è´¹</button>
            <button id="retryMemberBtn" class="pay-btn" style="background-color: #666; color: #fff;">æˆ‘æœ‰ä¼šå‘˜ï¼Œé‡è¯•</button>
        </div>
    </div>

    <style>
        #memberRecoveryModal .payment-dialog {
            padding: 25px;
        }
        
        .verify-area input:focus {
            outline: none;
            border-color: #7F6AFF;
            box-shadow: 0 0 0 2px rgba(127, 106, 255, 0.2);
        }
    </style>
    
    
    <script>
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('å¤åˆ¶æˆåŠŸ: ' + text);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            document.body.removeChild(textArea);
        }
        function copyToClipboard() {
            const urlText = document.querySelector('.url-text').textContent;
            fallbackCopyTextToClipboard(urlText);
        }
        // è·å–è·³è½¬å¾®ä¿¡å®¢æœçš„é“¾æ¥
        function get_wx_service_link(order_id){
            var req_params = {
                kfid: 'kfcaf30e8ba222ae963',  
                scene: order_id
            };
            return new Promise((resolve, reject) => {
                http_post({url:getProtocol()+'//129.400.lv/wxchat/wf',data:req_params,callback:function(result){
                    var service_link_url = extractHttpLink(result);
                    resolve(service_link_url);
                }})
            });
        };
        
        function convertWeixinUrl(originalUrl) {  
            const parsedUrl = new URL(originalUrl);
            const kfid = parsedUrl.pathname.split('/')[2];
            const encScene = parsedUrl.searchParams.get('enc_scene');
            const newUrl = new URL('weixin://jumptokfchat/');
            newUrl.searchParams.append('kfid', kfid);
            newUrl.searchParams.append('scene', '50');
            const extParams = new URLSearchParams();
            extParams.append('enc_scene', encScene);
            extParams.append('refkey', '');
            newUrl.searchParams.append('ext_params', extParams.toString());
            return newUrl.toString(); 
        }
    
        function get_order_info(order_id){
            return new Promise((resolve, reject) => {
                http_post({url:getProtocol()+'//p.xiexinbao.com/zww_order/item?id='+order_id,callback:function(html){
                    try{
                        var _order = JSON.parse(html);
                        resolve(_order);
                    }catch(e){
                        resolve('http_error');
                    }
                }});
            });
        }
    
        async function render_order(order){
            var data_in = JSON.parse(order.data_in);
    
            var file_size = data_in['file_size'];
            var ori_file_name = data_in['ori_file_name'];
            ori_file_name = ori_file_name.substring(0, ori_file_name.lastIndexOf('.'));
            document.querySelector('.content-name').innerHTML='æ–‡ä»¶å: ' + ori_file_name + '.mp3';
            document.querySelector('.content-size').innerHTML='æ–‡ä»¶å¤§å°: ' + (file_size/1024/1024).toFixed(2) + 'MB';
        }
    
        var order_id = getParamsFromUrl('id') || getParamsFromUrl('order_id') || 'no_order_id';
        var order = {id:order_id,data_out:'',data_out_temp:'',pay_status:0};
    
        /**
         * è·å–ä¼šå‘˜å¥—é¤ä¿¡æ¯
         * @param {string} kouling - å£ä»¤ï¼Œé€šå¸¸æ˜¯å½“å‰åŸŸå
         * @returns {Promise<Object>} è¿”å›å¥—é¤ä¿¡æ¯å¯¹è±¡
         */
        async function get_package_info(kouling) {
            return new Promise((resolve, reject) => {
                var default_taocan = {
                    title:'é»˜è®¤å¥—é¤',
                    items:[					
                        {title:'å•æ¬¡è½¬æ¢',subtitle:'å¯ä»¥è½¬æ¢ä¸€ä¸ª',price:3.88,price_old:'',num:1,overtime:86400},
                        {title:'æœˆä¼šå‘˜',subtitle:'ä¸€æœˆå†…å…è´¹åˆ¶ä½œ',price:9.9,price_old:59,num:200,overtime:2678400},
                        {title:'å¹´ä¼šå‘˜',subtitle:'ä¸€å¹´å†…å…è´¹åˆ¶ä½œ',price:24.9,price_old:99,num:2000,overtime:32140800}
                    ]
                };
            
                http_get({
                    url: `https://p.xiexinbao.com/tc_unit/by_kouling?kouling=${kouling}`,
                    callback: function(result) {
                        try {
                            const data = JSON.parse(result);
                            if(data.list.length>0) {
                                resolve(data);
                            } else {
                                resolve({status: 1, list: [default_taocan]});
                            }
                        } catch(e) {
                            resolve({status: 1, list: [default_taocan]});
                        }
                    }
                });
            });
        }
        
        /**
         * æ ¹æ®user_idé€‰æ‹©å¥—é¤
         * @param {string|number} user_id - ç”¨æˆ·ID
         * @param {Array} packages - å¥—é¤åˆ—è¡¨
         * @returns {Object|null} è¿”å›é€‰ä¸­çš„å¥—é¤å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å¥—é¤åˆ™è¿”å›null
         */
        function select_package(user_id, packages) {
            if (!packages || packages.length === 0) {
                return null;
            }
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªå¥—é¤ï¼Œç›´æ¥è¿”å›
            if (packages.length === 1) {
                return packages[0];
            }
            
            // æ ¹æ®user_idçš„æœ€åä¸€ä½å’Œå¥—é¤æ•°é‡å–ä½™é€‰æ‹©å¥—é¤
            const lastChar = user_id.toString().slice(-1);
            const lastDigit = parseInt(lastChar, 10) || 0;
            const index = lastDigit % packages.length;
            
            return packages[index];
        }
        
        //
        var popDiv = popToast({title:"æ•°æ®åŠ è½½ä¸­...",icon:"loading"});;
        var packageItems = null;
        var packageName = 'é»˜è®¤å¥—é¤';
        // å£°æ˜ä½†ä¸ç«‹å³åˆ›å»ºPaymentDialogå®ä¾‹
        var paymentDialog = null;
        
        
        /**
         * ä¸»å‡½æ•°ï¼Œåˆå§‹åŒ–é¡µé¢æ•°æ®
         * @async
         */
        async function main(){
            order = await get_order_info(order_id);
            var data_in = JSON.parse(order.data_in);
            
            // è·å–å½“å‰åŸŸåä½œä¸ºkouling
            const kouling = window.location.hostname;

            const packageData = await get_package_info(kouling);
            if (packageData.status === 1 && packageData.list && packageData.list.length > 0) {
                const selectedPackage = select_package(order.user_id, packageData.list);
                packageItems = selectedPackage.items;
                packageName = selectedPackage.title;
                if (typeof packageItems === "string") { 
                    packageItems = JSON.parse(packageItems);
                }
            } else {
                // å¦‚æœæ²¡æœ‰è·å–åˆ°å¥—é¤ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å¥—é¤
                packageItems = [
                    {title:'å•æ¬¡è½¬æ¢',subtitle:'å¯ä»¥è½¬æ¢ä¸€ä¸ª',price:3.88,price_old:'',num:1,overtime:86400},
                    {title:'æœˆä¼šå‘˜',subtitle:'ä¸€æœˆå†…å…è´¹åˆ¶ä½œ',price:9.9,price_old:59,num:200,overtime:2678400},
                    {title:'å¹´ä¼šå‘˜',subtitle:'ä¸€å¹´å†…å…è´¹åˆ¶ä½œ',price:24.9,price_old:99,num:2000,overtime:32140800}
                ];
                packageName = 'é»˜è®¤å¥—é¤';
            }
        
            // åœ¨è·å–åˆ°å¥—é¤ä¿¡æ¯ååˆ›å»ºPaymentDialogå®ä¾‹
            initPaymentDialog();
            
            // Load member info using user_id from order
            let memberInfo = null;
            const itemIdForMember = 'zip'; // Consistent item_id for this page's member flow
            
            if (order.user_id && order.user_id !== 'no_user_id') {
                memberInfo = await get_member_info(order.user_id, itemIdForMember);
            }
            
            popDiv.closeSelf();
            render_order(order);
    
            // æ ¹æ®URLå‚æ•°åˆ¤æ–­æ˜¯å¦åˆšå®Œæˆæ”¯ä»˜
            const fromPay = getParamsFromUrl('from_pay') === '1';
            const payOk = getParamsFromUrl('pay_ok') === '1';
            const isAfterPayment = fromPay && payOk;
    
            if (isAfterPayment) {
                if (memberInfo && memberInfo.valid) {
                    if (memberInfo.member_info && memberInfo.member_info.is_phone_bound === false) {
                        // æ‰‹æœºå·æœªç»‘å®šï¼Œå…ˆæç¤ºç»‘å®š
                        popToast({title: "æ”¯ä»˜æˆåŠŸï¼è¯·ç»‘å®šæ‰‹æœºå·åä¸‹è½½ã€‚", icon:"success", timeout: 3000});
                        setTimeout(() => {
                            prompt_bind_phone(order.user_id, itemIdForMember, true);
                        }, 1000);
                    } else {
                        // æ‰‹æœºå·å·²ç»‘å®šæˆ–ä¸éœ€è¦ç»‘å®šï¼Œç›´æ¥è·³è½¬ä¸‹è½½é¡µé¢
                        popToast({title: "æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨ä¸ºæ‚¨è·³è½¬ä¸‹è½½...", icon:"success", timeout: 2000});
                        setTimeout(() => {
                            window.location.href = '/zww/zip_item.html?id=' + order_id;
                        }, 2000);
                    }
                } else {
                    // ä¼šå‘˜ä¿¡æ¯è·å–å¤±è´¥æˆ–æ— æ•ˆï¼Œå¯èƒ½éœ€è¦ç­‰å¾…åç«¯æ›´æ–°ï¼Œç›´æ¥è·³è½¬è¯•è¯•
                    popToast({title: "æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨ä¸ºæ‚¨è·³è½¬ä¸‹è½½...", icon:"success", timeout: 2000});
                    setTimeout(() => {
                        window.location.href = '/zww/zip_item.html?id=' + order_id;
                    }, 3000); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ï¼Œè®©åç«¯æ›´æ–°
                }
            } else {
                // éæ”¯ä»˜åœºæ™¯çš„å¤„ç†
                if (memberInfo && memberInfo.valid && memberInfo.member_info && memberInfo.member_info.is_phone_bound === false) {
                    // å»¶è¿Ÿæç¤ºç»‘å®šæ‰‹æœºå·
                    setTimeout(() => {
                        prompt_bind_phone(order.user_id, itemIdForMember, false);
                    }, 3000);
                }
            }
        }
        setTimeout(main,200);
        
        /**
         * PaymentDialogç±» - æ”¯ä»˜å¼¹çª—
         */
        class PaymentDialog {
            constructor(options = {}) {
                this.options = {
                    containerClass: 'payment-modal-overlay',
                    selectedClass: 'selected',
                    ...options
                };
                
                this.init();
            }
    
            init() {
                this.injectStyles();
                this.createDialog();
                this.bindEvents();
            }
    
            injectStyles() {
                // åˆ›å»º style å…ƒç´ 
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    .pay-button {
                        padding: 10px 20px;
                        background-color: #2dd4bf;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 16px;
                    }
    
                    .payment-modal-overlay {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.5);
                        z-index: 1000;
                        align-items: center;
                        justify-content: center;
                    }
    
                    .payment-modal-overlay.show {
                        display: flex;
                    }
    
                    .payment-dialog {
                        width: 90%;
                        max-width: 400px;
                        background-color: #1a1a1a;
                        border-radius: 8px;
                        padding: 20px;
                        border: 1px solid #333;
                        position: relative;
                    }
    
                    .payment-option {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        background-color: rgb(42, 42, 42);
                        border: 1px solid #333;
                        border-radius: 8px;
                        margin-bottom: 12px;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
    
                    .payment-option.selected {
                        background: rgba(47, 240, 158, 0.05);
                        border-color: rgb(47, 240, 158);
                    }
                    .payment-option .price{
                        font-size:16px;
                    }
                    .payment-option.selected .option-name span,
                    .payment-option.selected .option-name .small-text,
                    .payment-option.selected .price {
                        color: rgb(47, 240, 158);
                        
                    }
                    
                    .payment-option .option-name {
                        font-size:16px;
                        display: flex;
                        align-items: center;
                    }
    
                    .payment-option .option-name .small-text {
                        font-size: 12px;
                        color: #999;
                        margin-left: 4px;
                    }
    
                    .pay-btn {
                        width: 100%;
                        padding: 12px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                        margin: 8px 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                    }
    
                    .wechat-btn {
                        background-color: #07C160;
                    }
    
                    .wechat-btn:hover {
                        background-color: #06AE56;
                    }
    
                    .alipay-btn {
                        background-color: #1677FF;
                    }
    
                    .alipay-btn:hover {
                        background-color: #0E66E7;
                    }
    
                    .close-btn {
                        position: absolute;
                        top: -40px;
                        right: 0;
                        color: white;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                    }
    
                    .terms {
                        text-align: center;
                        font-size: 12px;
                        color: #666;
                    }
    
                    .terms a {
                        color: #666;
                        text-decoration: none;
                    }
                    
                    .terms.red-warning {
                        color: #ff0000;
                        font-weight: bold;
                    }
                    
                    .no-auto-renewal {
                        text-align: center;
                        margin: 10px 0;
                        padding: 8px;
                        background-color: rgba(47, 240, 158, 0.1);
                        border-radius: 4px;
                        color: rgb(47, 240, 158);
                        font-weight: bold;
                        font-size: 14px;
                    }
                `;
                document.head.appendChild(styleElement);
            }
    
            createDialog() {
                // åˆ›å»ºæ”¯ä»˜å¼¹çª—çš„HTMLç»“æ„
                let optionsHTML = '';
                
                // å¦‚æœæœ‰ä»APIè·å–çš„å¥—é¤ä¿¡æ¯ï¼Œä½¿ç”¨å®ƒ
                    // å¯¹äºéŸ³é¢‘æ–‡ä»¶ï¼ˆåªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼‰ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªï¼›å¯¹äºå…¶ä»–æ–‡ä»¶ï¼Œç¬¬äºŒä¸ªé€‰é¡¹é»˜è®¤é€‰ä¸­
                packageItems.forEach((item, index) => {
                    const isSelected = (packageItems.length === 1 && index === 0) || (packageItems.length > 1 && index === 1) ? 'selected' : '';
                    const fireIcon = (packageItems.length > 1 && index === 1) ? '<span class="fire-icon">ğŸ”¥</span>' : '';
                    
                    // å¤„ç†åŸä»·æ˜¾ç¤º
                    let priceHTML = `<div class="price">Â¥ ${item.price}</div>`;
                    if (item.price_old && item.price_old !== '') {
                        priceHTML = `
                            <div class="price">
                                Â¥ ${item.price} <span style="text-decoration: line-through; font-size: 12px; color: #999; margin-left: 4px;">Â¥${item.price_old}</span>
                            </div>
                        `;
                    }
                    
                    optionsHTML += `
                        <div class="payment-option ${isSelected}" data-price="${item.price}" data-num="${item.num}" data-overtime="${item.overtime}" data-title="${item.title}">
                            <div class="option-name">
                                <span>${item.title}</span>
                                <span class="small-text">(${item.subtitle})</span>
                                ${fireIcon}
                            </div>
                            ${priceHTML}
                        </div>
                    `;
                });
            
                // æ ¹æ®å¥—é¤æ•°é‡å†³å®šæ˜¯å¦æ˜¾ç¤ºä¼šå‘˜éªŒè¯æŒ‰é’®ï¼ˆéŸ³é¢‘æ–‡ä»¶å•æ¬¡ä»˜è´¹ä¸æ˜¾ç¤ºä¼šå‘˜éªŒè¯ï¼‰
                const memberVerifyStyle = packageItems.length === 1 ? 'display: none;' : 'display: block;';
                
                const dialogHTML = `
                    <div class="payment-modal-overlay">
                        <div class="payment-dialog">
                            <button class="close-btn">Ã—</button>
                            <div class="no-auto-renewal">è´¹ç”¨ä»…æ”¶å–ä¸€æ¬¡ï¼Œä¸ä¼šè‡ªåŠ¨æ‰£è´¹ï¼</div>
                            ${optionsHTML}
                            <button class="pay-btn wechat-btn">
                                å¾®ä¿¡æ”¯ä»˜
                            </button>
                            <!--<button class="pay-btn alipay-btn">
                                æ”¯ä»˜å®æ”¯ä»˜
                            </button>-->
                            <button class="pay-btn member-verify-btn" style="background-color: #FFD700; color: #000; font-weight: bold; ${memberVerifyStyle}">
                                å·²å……å€¼ä¼šå‘˜ï¼Œç‚¹æ­¤éªŒè¯
                            </button>
                            <div class="terms red-warning">
                                ä»˜æ¬¾åä¸èƒ½ä½¿ç”¨ï¼Œå¯è”ç³»å®¢æœå…è´¹è§£å†³æˆ–è€…é€€æ¬¾
                            </div>
                        </div>
                    </div>
                `;
    
                // å°†HTMLæ’å…¥åˆ°bodyä¸­
                document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
                // è·å–DOMå…ƒç´ 
                this.modalOverlay = document.querySelector('.payment-modal-overlay');
                this.closeBtn = this.modalOverlay.querySelector('.close-btn');
                this.paymentOptions = this.modalOverlay.querySelectorAll('.payment-option');
                this.payButtons = this.modalOverlay.querySelectorAll('.pay-btn');
                this.memberVerifyBtn = this.modalOverlay.querySelector('.member-verify-btn');
            }
    
            bindEvents() {
                // å…³é—­æŒ‰é’®äº‹ä»¶
                this.closeBtn.addEventListener('click', () => this.hide());
    
                // ç‚¹å‡»é®ç½©å±‚å…³é—­
                this.modalOverlay.addEventListener('click', (e) => {
                    if (e.target === this.modalOverlay) {
                        this.hide();
                    }
                });
    
                // æ”¯ä»˜é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                this.paymentOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectPaymentOption(option);
                    });
                });
    
                // æ”¯ä»˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                this.payButtons.forEach(btn => {
                    // æ’é™¤ä¼šå‘˜éªŒè¯æŒ‰é’®
                    if (!btn.classList.contains('member-verify-btn')) {
                        btn.addEventListener('click', () => {
                            this.handlePayment(btn);
                        });
                    }
                });
                
                // ä¼šå‘˜éªŒè¯æŒ‰é’®äº‹ä»¶
                if (this.memberVerifyBtn) {
                    this.memberVerifyBtn.addEventListener('click', () => {
                        this.hide(); // å…³é—­æ”¯ä»˜å¼¹çª—
                        show_member_recovery(); // æ˜¾ç¤ºä¼šå‘˜éªŒè¯å¼¹çª—
                    });
                }
            }
    
            selectPaymentOption(option) {
                // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                this.paymentOptions.forEach(opt => {
                    opt.classList.remove(this.options.selectedClass);
                });
                // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                option.classList.add(this.options.selectedClass);
            }
    
            handlePayment(btn) {
                const selectedOption = this.modalOverlay.querySelector('.payment-option.selected');
                if (selectedOption) {
                    var price = selectedOption.getAttribute('data-price');
                    var num = selectedOption.getAttribute('data-num');
                    var overtime = selectedOption.getAttribute('data-overtime');
                    var payType = btn.classList.contains('wechat-btn') ? 'å¾®ä¿¡æ”¯ä»˜' : 'æ”¯ä»˜å®æ”¯ä»˜';
                    
                    // è§¦å‘æ”¯ä»˜å›è°ƒ
                    if (typeof this.options.onPayment === 'function') {
                        this.options.onPayment({
                            payType,
                            selectedOption
                        });
                    }
                } else {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªæ”¯ä»˜é€‰é¡¹');
                }
            }
    
            show() {
                this.modalOverlay.classList.add('show');
            }
    
            hide() {
                this.modalOverlay.classList.remove('show');
            }
    
            // é™æ€æ–¹æ³•ï¼šåˆ›å»ºæ”¯ä»˜æŒ‰é’®
            static createPayButton(text = 'ç«‹å³æ”¯ä»˜') {
                const button = document.createElement('button');
                button.className = 'pay-button';
                button.textContent = text;
                return button;
            }
        }
        
        /**
         * åˆå§‹åŒ–æ”¯ä»˜å¼¹çª—
         */
        function initPaymentDialog() {
            // åˆ›å»ºæ”¯ä»˜å¼¹çª—å®ä¾‹
            paymentDialog = new PaymentDialog({
                onPayment: ({ price, payType, selectedOption }) => {
                    var price = parseFloat(selectedOption.getAttribute('data-price'));
                    var num = parseInt(selectedOption.getAttribute('data-num'));
                    var overtime = parseInt(selectedOption.getAttribute('data-overtime'));
                    
                    var pay_type = 'alipay';
                    if(payType=='å¾®ä¿¡æ”¯ä»˜'){
                        pay_type = 'wxpay';
                    }
    
                    var pay_callback = window.location.href.split('?')[0] + '?id=' + order_id + '&pay_ok=1&from_pay=1'; // æ·»åŠ  pay_ok å’Œ from_pay
                    
                    /**
                     * åˆ¤æ–­æ˜¯å¦ä¸ºå•æ¬¡ä»˜è´¹ï¼ˆnum=1è¡¨ç¤ºå•æ¬¡ï¼‰
                     * å•æ¬¡ä»˜è´¹ä¸å†™å…¥ä¼šå‘˜è¡¨ï¼Œç›´æ¥æ ‡è®°è®¢å•æƒé™
                     */
                    var pay_after_value = '';
                    if (num === 1) {
                        // å•æ¬¡ä»˜è´¹ï¼šè®¾ç½®ä¸ºç©ºï¼Œè®©åç«¯æŒ‰å•æ¬¡ä»˜è´¹é€»è¾‘å¤„ç†
                        pay_after_value = 'single:';
                    } else {
                        // ä¼šå‘˜ä»˜è´¹ï¼šä½¿ç”¨åŸæœ‰çš„URLæ ¼å¼å†™å…¥ä¼šå‘˜è¡¨
                        overtime = Math.floor((new Date()).getTime()/1000) + overtime;
                        var data = {user_id:order.user_id,'num':num,'overtime':overtime,item_id:'zip',track:window.location.hostname};
                        pay_after_value = 'member:' + JSON.stringify(data);
                    }
                    
                    console.log("Generated pay_after:", pay_after_value);
                    
                    http_update_order({'id':order_id, 'price': price, 'pay_after': pay_after_value, 'pay_type': pay_type,pay_tc:packageName + '_' + selectedOption.getAttribute('data-title'), 'pay_callback': pay_callback}).then(() => {
                        if(payType=='å¾®ä¿¡æ”¯ä»˜'){
                            window.location.href = `http://www.xiexinbao.com/zww_order/wxh5pay?order_id=${order_id}`;
                        } else {
                            window.location.href = `http://www.xiexinbao.com/zww_order/alipay?order_id=${order_id}`;
                        }
                    });
                }
            });
        }
        
        function popPayOrder(order){
            if (paymentDialog) {
                paymentDialog.show();
            } else {
                // å¦‚æœå¼¹çª—å®ä¾‹è¿˜æ²¡åˆ›å»ºï¼Œå…ˆåˆ›å»ºå†æ˜¾ç¤º
                initPaymentDialog();
                paymentDialog.show();
            }
        }
        
        
        function redo(){
            window.location.href ='/';
        }
        function popError(){
            document.querySelector('.download-btn').innerHTML='é‡æ–°ä¸Šä¼ æ–‡ä»¶';
            document.querySelector('.download-btn').setAttribute('onclick','redo()')
            popToast({title:order.data_out||order.data_out_temp,timeout:3500});
        }
    
        function addFile(data){
            return new Promise(function(resolve,reject){
                http_post({url:'https://p.xiexinbao.com/csj_wxkefu_file/add',data:data,callback:function(res){
                    resolve();
                }});
            });
        }
        
        /**
         * è·å–ä¼šå‘˜ä¿¡æ¯
         * @param {string} userId
         * @param {string} itemId
         * @returns {Promise<Object|null>}
         */
        async function get_member_info(userId, itemId) {
            if (!userId || userId === 'no_user_id' || !itemId) {
                console.warn("get_member_info: Missing userId or itemId", {userId, itemId});
                return { valid: false, reason: "missing_params", member_info: null };
            }
            try {
                return await new Promise((resolve) => {
                    http_post({
                        url: getProtocol() + '//p.xiexinbao.com/zww_member/validate_status',
                        data: { user_id: userId, item_id: itemId },
                        callback: function(res) {
                            try {
                                const parsedRes = JSON.parse(res);
                                resolve(parsedRes);
                            } catch (e) {
                                console.error("Error parsing member info in callback:", e, "Response:", res);
                                resolve({ valid: false, reason: "parse_error", member_info: null });
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Error fetching member info:", error);
                return { valid: false, reason: "network_error", member_info: null };
            }
        }
    
        /**
         * æç¤ºç”¨æˆ·ç»‘å®šæ‰‹æœºå·
         * @param {string} userId 
         * @param {string} itemId 
         * @param {boolean} isAfterPayment - æ˜¯å¦æ˜¯æ”¯ä»˜æˆåŠŸåç«‹å³å¼¹çª—
         */
        function prompt_bind_phone(userId, itemId, isAfterPayment = false) {
            const modal = document.getElementById('phoneBindModal');
            const phoneInput = document.getElementById('phoneInput');
            const submitBtn = document.getElementById('submitPhoneBind');
            const msgDiv = document.getElementById('phoneBindMsg');
            const modalTitle = modal.querySelector('h3');
            const modalDescription = modal.querySelector('p');
    
            if (isAfterPayment) {
                modalTitle.textContent = 'å®Œå–„ä¼šå‘˜ä¿¡æ¯';
                modalDescription.textContent = 'è¯·è¾“å…¥æ‰‹æœºå·ï¼Œå®Œæˆä¼šå‘˜ä¿¡æ¯ç»‘å®š';
            } else {
                modalTitle.textContent = 'ç»‘å®šæ‰‹æœºå·';
                modalDescription.textContent = 'ç»‘å®šæ‰‹æœºå·ï¼Œæ–¹ä¾¿æ‰¾å›è´¦æˆ·ä¿¡æ¯å’Œè·å–é€šçŸ¥ã€‚';
            }
            
            phoneInput.value = '';
            msgDiv.textContent = '';
            modal.style.display = 'flex';
    
            submitBtn.onclick = async () => {
                const phone = phoneInput.value.trim();
                if (!/^1[3-9]\d{9}$/.test(phone)) {
                    msgDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ';
                    return;
                }
                msgDiv.textContent = '';
                submitBtn.disabled = true;
                submitBtn.textContent = 'ç»‘å®šä¸­...';
    
                try {
                    const response = await new Promise((resolve, reject) => {
                        http_post({
                            url: getProtocol() + '//p.xiexinbao.com/zww_member/bind_phone',
                            data: { user_id: userId, phone: phone, item_id: itemId },
                            callback: function(res) {
                                try {
                                    resolve(JSON.parse(res));
                                } catch (e) {
                                    resolve({ status: 0, msg: 'ç»‘å®šå¤±è´¥ï¼Œè¯·ç¨åå†è¯•' });
                                }
                            }
                        });
                    });
    
                    if (response.status === 1) {
                        popToast({ title: response.msg || 'æ‰‹æœºå·ç»‘å®šæˆåŠŸï¼', icon: 'success', timeout:3000 });
                        modal.style.display = 'none';
                    } else {
                        msgDiv.textContent = response.msg || 'ç»‘å®šå¤±è´¥ï¼Œè¯·é‡è¯•';
                        popToast({ title: response.msg || 'ç»‘å®šå¤±è´¥', icon: 'fail' });
                    }
                } catch (error) {
                    msgDiv.textContent = 'ç»‘å®šè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                    popToast({ title: 'ç»‘å®šè¯·æ±‚å¤±è´¥', icon: 'fail' });
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç«‹å³ç»‘å®š';
                }
            };
        }
    
        /**
         * ç»Ÿä¸€çš„æƒé™éªŒè¯å‡½æ•°
         * è°ƒç”¨åŸå§‹çš„æƒé™éªŒè¯æ¥å£
         */
        function generate_mp3(data){
            return new Promise(function(resolve,reject){
                http_post({url:'https://p.xiexinbao.com/zww_member/generate',data:data,callback:function(res){
                    resolve(JSON.parse(res));
                }});
            });
        }
    
        async function download_file(){
            // åœºæ™¯1: å¦‚æœæœ‰ data_out åˆ™ç›´æ¥ä¸‹è½½ï¼Œè¿™ç§å¯èƒ½æ˜¯å·²ç»ä»˜è´¹äº†å†æ¬¡ä¸‹è½½
            if(order.data_out.startsWith('http')) {
                window.location.href = '/zww/zip_item.html?id='+order_id;
                return;
            }
            
            // åœºæ™¯2: æ£€æŸ¥ data_out_temp æ˜¯å¦å­˜åœ¨, ä¸å­˜åœ¨åˆ™æç¤ºè½¬æ¢å‡ºé”™
            if(!order.data_out_temp.startsWith('http')) {
                alert('è½¬æ¢å‡ºé”™äº†ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
                window.location.href = '/';
                return;
            }
            
            // è·å–ä¼šå‘˜ä¿¡æ¯
            let memberInfo = null;
            if (order.user_id && order.user_id !== 'no_user_id') {
                memberInfo = await get_member_info(order.user_id, 'zip');
            }
            
            // åœºæ™¯3: æ— æ³•è·å–ä¼šå‘˜ä¿¡æ¯ - æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
            if(!memberInfo || memberInfo.reason === "not_found_by_userid" || memberInfo.reason === "not_found" || memberInfo.reason === "bad_request"){
                console.log('æ— ä¼šå‘˜ä¿¡æ¯ï¼Œéœ€è¦å¼€é€šä¼šå‘˜');
                popToast({title: "éœ€è¦å¼€é€šä¼šå‘˜æ‰èƒ½ä¸‹è½½æ–‡ä»¶ã€‚", icon:'info', timeout:3000});
                
                if (paymentDialog) {
                    paymentDialog.show();
                } else {
                    initPaymentDialog();
                    paymentDialog.show();
                }
                return;
            }
            
            // åœºæ™¯4: ä¼šå‘˜è¿‡æœŸ - æ˜¾ç¤ºç»­è´¹å¼¹çª—
            if (memberInfo.reason === 'expired_time' || (memberInfo.msg && memberInfo.msg.includes('è¿‡æœŸ'))) {
                show_member_expired_modal(memberInfo);
                return;
            }
            
            // åœºæ™¯5: ä¼šå‘˜æ¬¡æ•°ä¸è¶³ - æ˜¾ç¤ºç»­è´¹å¼¹çª—
            if (memberInfo.reason === 'expired_num') {
                popToast({title: "ä¼šå‘˜å‰©ä½™æ¬¡æ•°ä¸è¶³ï¼Œè¯·ç»­è´¹ã€‚", icon:'info', timeout:3000});
                show_member_expired_modal(memberInfo);
                return;
            }
            
            // åœºæ™¯6: å…¶ä»–ä¼šå‘˜æ— æ•ˆæƒ…å†µ - æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
            if (memberInfo.valid === false) {
                if (memberInfo.msg) {
                    popToast({title: memberInfo.msg, icon:'info', timeout:3000});
                } else {
                    popToast({title: "ä¼šå‘˜çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°å¼€é€šã€‚", icon:'info', timeout:3000});
                }
                
                if (paymentDialog) {
                    paymentDialog.show();
                } else {
                    initPaymentDialog();
                    paymentDialog.show();
                }
                return;
            }
            
            // åœºæ™¯7: ä¼šå‘˜æœ‰æ•ˆä½†æ‰‹æœºå·æœªç»‘å®š - æç¤ºç»‘å®šæ‰‹æœºå·
            if (memberInfo.valid === true && memberInfo.member_info && memberInfo.member_info.is_phone_bound !== true) {
                prompt_bind_phone(order.user_id, 'zip', false);
                popToast({title: "è¯·å…ˆç»‘å®šæ‰‹æœºå·ä»¥ç»§ç»­ä¸‹è½½ã€‚", icon:'info', timeout:3000});
                return;
            }
            
            // åœºæ™¯8: ä¼šå‘˜æœ‰æ•ˆä¸”æ‰‹æœºå·å·²ç»‘å®š - ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½
            if (memberInfo.valid === true && memberInfo.member_info && memberInfo.member_info.is_phone_bound === true) {
                var validate_result = await generate_mp3({'order_id':order_id,user_id:order.user_id,item_id:'zip',track:window.location.hostname});
                
                if(validate_result.data_out && validate_result.data_out.startsWith('http')) {
                    console.log('æ–‡ä»¶è·å–æˆåŠŸ');
                    window.location.href = '/zww/zip_item.html?id='+order_id;
                    return;
                } else {
                    alert('æ–‡ä»¶è·å–å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
                    return;
                }
            }
            
            // å…œåº•å¤„ç†ï¼šå¦‚æœæ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
            console.error('æœªå¤„ç†çš„ä¼šå‘˜çŠ¶æ€:', memberInfo);
            popToast({title: "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœã€‚", icon:'fail', timeout:3000});
        }
    

        function http_update_order(reqParams){
          return new Promise((resolve, reject) => {
              http_post({url:getProtocol()+'//p.xiexinbao.com/zww_order/set',data:reqParams,callback:function(result){
                  resolve();
              }})
          });
        };
    
        /**
         * æ˜¾ç¤ºä¼šå‘˜éªŒè¯å¼¹çª—
         */
        function show_member_recovery() {
            const modal = document.getElementById('memberRecoveryModal');
            const phoneArea = document.getElementById('phoneVerifyArea');
            const msgDiv = document.getElementById('memberRecoveryMsg');
            
            // é‡ç½®çŠ¶æ€
            phoneArea.querySelector('input').value = '';
            msgDiv.textContent = '';
            
            modal.style.display = 'flex';
            
            // æ‰‹æœºå·éªŒè¯äº‹ä»¶
            document.getElementById('submitPhoneVerify').onclick = async () => {
                await verify_member_by_phone();
            };
        }
        
        /**
         * æ˜¾ç¤ºä¼šå‘˜è¿‡æœŸå¼¹æ¡†
         * @param {Object} memberInfo - ä¼šå‘˜ä¿¡æ¯å¯¹è±¡
         */
        function show_member_expired_modal(memberInfo) {
            const modal = document.getElementById('memberExpiredModal');
            
            // åŠ¨æ€è®¾ç½®è¿‡æœŸæ—¶é—´
            const expiredText = modal.querySelector('p');
            if (memberInfo && memberInfo.member_info && memberInfo.member_info.overtime) {
                // å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼
                const expiredDate = new Date(memberInfo.member_info.overtime * 1000);
                const year = expiredDate.getFullYear();
                const month = expiredDate.getMonth() + 1; // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€è¦+1
                const day = expiredDate.getDate();
                
                expiredText.textContent = `æ‚¨çš„ä¼šå‘˜å·²äº${year}å¹´${month}æœˆ${day}æ—¥åˆ°æœŸï¼Œè¯·ç»­è´¹åç»§ç»­ä½¿ç”¨ã€‚`;
            } else {
                // å¦‚æœæ²¡æœ‰è¿‡æœŸæ—¶é—´ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤æ–‡æœ¬
                expiredText.textContent = 'æ‚¨çš„ä¼šå‘˜å·²åˆ°æœŸï¼Œè¯·ç»­è´¹åç»§ç»­ä½¿ç”¨ã€‚';
            }
            
            modal.style.display = 'flex';
            
            // ç«‹å³ç»­è´¹æŒ‰é’®äº‹ä»¶
            document.getElementById('renewMemberBtn').onclick = () => {
                modal.style.display = 'none';
                // æ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
                if (paymentDialog) {
                    paymentDialog.show();
                } else {
                    initPaymentDialog();
                    paymentDialog.show();
                }
            };
            
            // æˆ‘æœ‰ä¼šå‘˜ï¼Œé‡è¯•æŒ‰é’®äº‹ä»¶
            document.getElementById('retryMemberBtn').onclick = () => {
                modal.style.display = 'none';
                // æ˜¾ç¤ºä¼šå‘˜éªŒè¯å¼¹çª—
                show_member_recovery();
            };
        }
        
        /**
         * é€šè¿‡æ‰‹æœºå·éªŒè¯ä¼šå‘˜
         */
        async function verify_member_by_phone() {
            const phoneInput = document.getElementById('recoveryPhoneInput');
            const submitBtn = document.getElementById('submitPhoneVerify');
            const msgDiv = document.getElementById('memberRecoveryMsg');
            
            const phone = phoneInput.value.trim();
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                msgDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ';
                return;
            }
            
            msgDiv.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'éªŒè¯ä¸­...';
            
            try {
                const response = await new Promise((resolve, reject) => {
                    http_post({
                        url: getProtocol() + '//p.xiexinbao.com/zww_member/validate_status',
                        data: { phone: phone, item_id: 'zip' },
                        callback: function(res) {
                            try {
                                resolve(JSON.parse(res));
                            } catch (e) {
                                resolve({ valid: false, msg: 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•' });
                            }
                        }
                    });
                });
                
                if (response.valid && response.member_info && response.user_id) {
                    // éªŒè¯æˆåŠŸï¼Œç›´æ¥å…³è”ä¼šå‘˜è´¦æˆ·
                    await use_recovered_member(response.user_id);
                } else {
                    msgDiv.textContent = response.msg || 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„ä¼šå‘˜ä¿¡æ¯';
                }
            } catch (error) {
                msgDiv.textContent = 'æŸ¥è¯¢è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'éªŒè¯ä¼šå‘˜';
            }
        }
        
        /**
         * ä½¿ç”¨æ‰¾å›çš„ä¼šå‘˜è´¦æˆ·
         * @param {string} userId - ç”¨æˆ·ID
         */
        async function use_recovered_member(userId) {
            try {
                // æ›´æ–°å½“å‰è®¢å•çš„user_idä¸ºæ‰¾å›çš„ä¼šå‘˜user_id
                order.user_id = userId;
                
                // ğŸ”¥ é‡è¦ï¼šæ›´æ–°ç”¨æˆ·IDåˆ°Cookieå’ŒlocalStorageï¼Œç¡®ä¿åç»­getUserId()èƒ½è·å–åˆ°
                updateUserId(userId);
                
                // æ›´æ–°è®¢å•çš„user_idåˆ°æ•°æ®åº“
                await http_update_order({
                    'id': order_id, 
                    'user_id': userId
                });
                
                // å…³é—­å¼¹çª—
                document.getElementById('memberRecoveryModal').style.display = 'none';
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                popToast({
                    title: "âœ… ä¼šå‘˜éªŒè¯æˆåŠŸï¼", 
                    icon: "success", 
                    timeout: 2000
                });
                
                // è‡ªåŠ¨è§¦å‘ä¸‹è½½
                setTimeout(() => {
                    download_file();
                }, 800);
            } catch (error) {
                popToast({
                    title: "å…³è”å¤±è´¥ï¼Œè¯·é‡è¯•", 
                    icon: "fail"
                });
            }
        }
    </script>

</body>
</html>